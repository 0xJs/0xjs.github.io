<!DOCTYPE html><html lang="en" data-mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Searching recursivly through Azure AD Groups and Roles" /><meta name="author" content="Jony Schats" /><meta property="og:locale" content="en" /><meta name="description" content="Introduction During some courses I have been working with the AzureAD PowerShell Module to retrieve information from Users, Groups, Roles etc. While working with these cmdlets it was annoying that it doesn’t have a functionality to recursivly search through group objects. So I wrote two modules to recursivly search through group objects and roles and only return the user objects. Then I also wanted to get a overview of the Azure AD roles and privileged roles and their users? This blogpost will be the first of the series about priviliged identities. In this blogpost I will describe and share the PowerShell cmdlets I created which will help with enumerating Azure AD Group and Role user memberships." /><meta property="og:description" content="Introduction During some courses I have been working with the AzureAD PowerShell Module to retrieve information from Users, Groups, Roles etc. While working with these cmdlets it was annoying that it doesn’t have a functionality to recursivly search through group objects. So I wrote two modules to recursivly search through group objects and roles and only return the user objects. Then I also wanted to get a overview of the Azure AD roles and privileged roles and their users? This blogpost will be the first of the series about priviliged identities. In this blogpost I will describe and share the PowerShell cmdlets I created which will help with enumerating Azure AD Group and Role user memberships." /><link rel="canonical" href="https://0xjs.github.io/posts/Searching-recursivl-through-Azure-AD-Groups-and-Roles/" /><meta property="og:url" content="https://0xjs.github.io/posts/Searching-recursivl-through-Azure-AD-Groups-and-Roles/" /><meta property="og:site_name" content="Jony Schats / 0xjs" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-11-12T12:45:00+01:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Searching recursivly through Azure AD Groups and Roles" /><meta name="twitter:site" content="@_0xJs_" /><meta name="twitter:creator" content="@Jony Schats" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Jony Schats"},"dateModified":"2022-11-12T12:45:00+01:00","datePublished":"2022-11-12T12:45:00+01:00","description":"Introduction During some courses I have been working with the AzureAD PowerShell Module to retrieve information from Users, Groups, Roles etc. While working with these cmdlets it was annoying that it doesn’t have a functionality to recursivly search through group objects. So I wrote two modules to recursivly search through group objects and roles and only return the user objects. Then I also wanted to get a overview of the Azure AD roles and privileged roles and their users? This blogpost will be the first of the series about priviliged identities. In this blogpost I will describe and share the PowerShell cmdlets I created which will help with enumerating Azure AD Group and Role user memberships.","headline":"Searching recursivly through Azure AD Groups and Roles","mainEntityOfPage":{"@type":"WebPage","@id":"https://0xjs.github.io/posts/Searching-recursivl-through-Azure-AD-Groups-and-Roles/"},"url":"https://0xjs.github.io/posts/Searching-recursivl-through-Azure-AD-Groups-and-Roles/"}</script><title>Searching recursivly through Azure AD Groups and Roles | Jony Schats / 0xjs</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Jony Schats / 0xjs"><meta name="application-name" content="Jony Schats / 0xjs"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src=" https://hackdefense.nl/imager/images/team/14056/DSC_5203_mod_24616cf13bdaf96affec076df364e814.jpg " alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Jony Schats / 0xjs</a></div><div class="site-subtitle font-italic">Ethical Hacker & Security enthusiast</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/0xjs" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/_0xJs_" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['me AT jonyschats.nl',''].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Searching recursivly through Azure AD Groups and Roles</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Searching recursivly through Azure AD Groups and Roles</h1><div class="post-meta text-muted"><div> By <em> <a href="https://twitter.com/_0xJs_">Jony Schats</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" data-ts="1668253500" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2022-11-12 </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1935 words"> <em>10 min</em> read</span></div></div></div><div class="post-content"><h1 id="introduction">Introduction</h1><p>During some courses I have been working with the AzureAD PowerShell Module to retrieve information from Users, Groups, Roles etc. While working with these cmdlets it was annoying that it doesn’t have a functionality to recursivly search through group objects. So I wrote two modules to recursivly search through group objects and roles and only return the user objects. Then I also wanted to get a overview of the Azure AD roles and privileged roles and their users? This blogpost will be the first of the series about priviliged identities. In this blogpost I will describe and share the PowerShell cmdlets I created which will help with enumerating Azure AD Group and Role user memberships.</p><p>In Azure there are three identities that can have access to resources:</p><ul><li>Users<li>Groups<ul><li>Can have users, serviceprincipals or other groups as members</ul><li>ServicePrincipals</ul><p>In the first blog we will focus on retrieving users out of groups and roles.</p><h1 id="the-problem-with-azure-ad-cmdlets-when-querying-for-memberships">The problem with Azure AD cmdlets when querying for memberships</h1><p>When quering members of a group with the cmdlet <code class="language-plaintext highlighter-rouge">Get-AzureADGroupMember</code> the cmdlet returns user, serviceprincipal and group objects. In the output below an example is shown where it returns the user <code class="language-plaintext highlighter-rouge">GroupUser</code> and the group <code class="language-plaintext highlighter-rouge">NestedGroup</code>.</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre>Get-AzureADGroupMember -ObjectId f5108639-9aca-4694-864e-c4e00186706b

ObjectId                             DisplayName UserPrincipalName       UserType
--------                             ----------- -----------------       --------
eb815e66-31a5-45ca-bed8-2b0f5e24f62f GroupUser   GroupUser@jonyschats.nl Member

DeletionTimestamp            :
ObjectId                     : 50c16bf1-5016-4dfe-8bcc-d273c3b02f02
ObjectType                   : Group
Description                  :
DirSyncEnabled               :
DisplayName                  : NestedGroup
LastDirSyncTime              :
Mail                         :
MailEnabled                  : False
MailNickName                 : 295cb161-8
OnPremisesSecurityIdentifier :
ProvisioningErrors           : {}
ProxyAddresses               : {}
SecurityEnabled              : True
</pre></table></code></div></div><p>But it is missing the user that is part of the group <code class="language-plaintext highlighter-rouge">NestedGroup</code> and I would like to only retrieve the userobjects. The same happens for roles since you can assign groups and users to a role.</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre>Get-AzureADDirectoryRoleMember -ObjectId 598a6cfe-5d1a-42a7-81b6-76f4ab077152

ObjectId                             DisplayName    UserPrincipalName            UserType
--------                             -----------    -----------------            --------
fb8a7905-e32c-4431-9e66-2968013f924f SecurityReader SecurityReader@jonyschats.nl Member

DeletionTimestamp            :
ObjectId                     : 15c39279-6020-4a08-891f-8d76b6b86036
ObjectType                   : Group
Description                  :
DirSyncEnabled               :
DisplayName                  : Security Reader AD Group
LastDirSyncTime              :
Mail                         :
MailEnabled                  : False
MailNickName                 : 62ac515e-a
OnPremisesSecurityIdentifier :
ProvisioningErrors           : {}
ProxyAddresses               : {}
SecurityEnabled              : True
</pre></table></code></div></div><p>The output is missing the user of the group <code class="language-plaintext highlighter-rouge">Security Reader AD Group</code>.</p><h1 id="new-cmdlets-for-recursively-searching-through-groups-and-roles">New cmdlets for recursively searching through groups and roles</h1><h3 id="get-azureadgroupmemberrecursive"><span class="mr-2">Get-AzureADGroupMemberRecursive</span><a href="#get-azureadgroupmemberrecursive" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>So I created the PowerShell cmdlet <code class="language-plaintext highlighter-rouge">Get-AzureADGroupMemberRecursive</code> which takes a group object as input and recursivly searches through all group objects and returns user objects. The code of the cmdlet is:</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
</pre><td class="rouge-code"><pre><span class="kr">Function</span><span class="w"> </span><span class="nf">Get-AzureADGroupMemberRecursive</span><span class="p">{</span><span class="w">
</span><span class="cm">&lt;#
</span><span class="cs">.SYNOPSIS</span><span class="cm">
Author: Jony Schats - 0xjs
Required Dependencies: Get-AzureADGroupMember
Optional Dependencies: None
</span><span class="cs">.DESCRIPTION</span><span class="cm">
Recursively search through groups and only return unique user objects. Requires the Get-AzureADGroup as input.
</span><span class="cs">.EXAMPLE</span><span class="cm">
Get-AzureADGroup -ObjectId &lt;ID&gt; | Get-AzureADGroupMemberRecursive
</span><span class="cs">.EXAMPLE</span><span class="cm">
Get-AzureADGroup | Where-Object -Property Displayname -eq "&lt;GROUP&gt;" | Get-AzureADGroupMemberRecursive
#&gt;</span><span class="w">
	</span><span class="p">[</span><span class="n">cmdletbinding</span><span class="p">()]</span><span class="w">
	</span><span class="kr">param</span><span class="p">(</span><span class="w">
	</span><span class="p">[</span><span class="n">parameter</span><span class="p">(</span><span class="n">Mandatory</span><span class="o">=</span><span class="nv">$True</span><span class="p">,</span><span class="n">ValueFromPipeline</span><span class="o">=</span><span class="bp">$true</span><span class="p">)]</span><span class="w">
	</span><span class="nv">$AzureGroup</span><span class="w">
	</span><span class="p">)</span><span class="w">
		</span><span class="kr">Begin</span><span class="p">{</span><span class="w">
			</span><span class="kr">If</span><span class="p">(</span><span class="o">-not</span><span class="p">(</span><span class="n">Get-AzureADCurrentSessionInfo</span><span class="p">)){</span><span class="n">Connect-AzureAD</span><span class="p">}</span><span class="w">
			</span><span class="nv">$Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">@()</span><span class="w">
		</span><span class="p">}</span><span class="w">
		</span><span class="kr">Process</span><span class="w"> </span><span class="p">{</span><span class="w">
			</span><span class="n">Write-Verbose</span><span class="w"> </span><span class="nt">-Message</span><span class="w"> </span><span class="s2">"Enumerating </span><span class="si">$(</span><span class="nv">$AzureGroup</span><span class="o">.</span><span class="nf">DisplayName</span><span class="si">)</span><span class="s2">"</span><span class="w">
			</span><span class="nv">$Members</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Get-AzureADGroupMember</span><span class="w"> </span><span class="nt">-ObjectId</span><span class="w"> </span><span class="nv">$AzureGroup</span><span class="o">.</span><span class="nf">ObjectId</span><span class="w"> </span><span class="nt">-All</span><span class="w"> </span><span class="bp">$true</span><span class="w">
			</span><span class="nv">$UserMembers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$Members</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Where-Object</span><span class="p">{</span><span class="bp">$_</span><span class="o">.</span><span class="nf">ObjectType</span><span class="w"> </span><span class="o">-eq</span><span class="w"> </span><span class="s1">'User'</span><span class="p">}</span><span class="w">
			</span><span class="nv">$Output</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nv">$UserMembers</span><span class="w">
			
			</span><span class="nv">$GroupMembers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$Members</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Where-Object</span><span class="p">{</span><span class="bp">$_</span><span class="o">.</span><span class="nf">ObjectType</span><span class="w"> </span><span class="o">-eq</span><span class="w"> </span><span class="s1">'Group'</span><span class="p">}</span><span class="w">
			</span><span class="kr">If</span><span class="p">(</span><span class="nv">$GroupMembers</span><span class="p">){</span><span class="w">
				</span><span class="nv">$UserMembers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$GroupMembers</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">ForEach-Object</span><span class="p">{</span><span class="w"> </span><span class="n">Get-AzureADGroupMemberRecursive</span><span class="w"> </span><span class="nt">-AzureGroup</span><span class="w"> </span><span class="bp">$_</span><span class="p">}</span><span class="w">
				</span><span class="nv">$Output</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nv">$UserMembers</span><span class="w">
			</span><span class="p">}</span><span class="w">
		</span><span class="p">}</span><span class="w">
		</span><span class="kr">end</span><span class="w"> </span><span class="p">{</span><span class="w">
			</span><span class="kr">Return</span><span class="w"> </span><span class="nv">$Output</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Sort-Object</span><span class="w"> </span><span class="nt">-Unique</span><span class="w">
		</span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><p>Below is example output where it retrieves the user <code class="language-plaintext highlighter-rouge">GroupUser</code> of the group <code class="language-plaintext highlighter-rouge">test group</code>, but also the user <code class="language-plaintext highlighter-rouge">NestedGroupUser</code> from the group <code class="language-plaintext highlighter-rouge">NestedGroup</code> which is member of the group <code class="language-plaintext highlighter-rouge">test group</code>. The membership structure is as follows:</p><ul><li>Test group<ul><li>GroupUser@jonyschats.nl<li>NestedGroup<ul><li>NestedGroupUser@jonyschats.nl</ul></ul></ul><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>Get-AzureADGroup -ObjectId f5108639-9aca-4694-864e-c4e00186706b | Get-AzureADGroupMemberRecursive

ObjectId                             DisplayName     UserPrincipalName             UserType
--------                             -----------     -----------------             --------
1a9a26f4-297a-4dec-95b3-e502ec8e9dfc NestedGroupUser NestedGroupUser@jonyschats.nl Member
eb815e66-31a5-45ca-bed8-2b0f5e24f62f GroupUser       GroupUser@jonyschats.nl       Member
</pre></table></code></div></div><h3 id="get-azureaddirectoryrolememberrecursive"><span class="mr-2">Get-AzureADDirectoryRoleMemberRecursive</span><a href="#get-azureaddirectoryrolememberrecursive" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>Roles can also have user and group objects as members. So I created the PowerShell cmdlet <code class="language-plaintext highlighter-rouge">Get-AzureADDirectoryRoleMemberRecursive</code> which uses the <code class="language-plaintext highlighter-rouge">Get-AzureADGroupMemberRecursive</code> cmdlet to recursivly search through all the groups assigned to the role and returns all the users. The code of the cmdlet is:</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
</pre><td class="rouge-code"><pre><span class="kr">Function</span><span class="w"> </span><span class="nf">Get-AzureADDirectoryRoleMemberRecursive</span><span class="p">{</span><span class="w">
</span><span class="cm">&lt;#
</span><span class="cs">.SYNOPSIS</span><span class="cm">
Author: Jony Schats - 0xjs
Required Dependencies: Get-AzureADDirectoryRoleMember, Get-AzureADGroupMember, Get-AzureADGroupMemberRecursive
Optional Dependencies: None
</span><span class="cs">.DESCRIPTION</span><span class="cm">
Recursively search through roles and only return unique user objects. Requires the Get-AzureADDirectoryRole as input.
</span><span class="cs">.EXAMPLE</span><span class="cm">
Get-AzureADDirectoryRole -ObjectId &lt;ID&gt; | Get-AzureADDirectoryRoleMemberRecursive
</span><span class="cs">.EXAMPLE</span><span class="cm">
Get-AzureADDirectoryRole | Where-Object -Property Displayname -eq "&lt;ROLE&gt;" | Get-AzureADDirectoryRoleMemberRecursive
#&gt;</span><span class="w">
	</span><span class="p">[</span><span class="n">cmdletbinding</span><span class="p">()]</span><span class="w">
	</span><span class="kr">param</span><span class="p">(</span><span class="w">
	</span><span class="p">[</span><span class="n">parameter</span><span class="p">(</span><span class="n">Mandatory</span><span class="o">=</span><span class="nv">$True</span><span class="p">,</span><span class="n">ValueFromPipeline</span><span class="o">=</span><span class="bp">$true</span><span class="p">)]</span><span class="w">
	</span><span class="nv">$RoleGroup</span><span class="w">
	</span><span class="p">)</span><span class="w">
		</span><span class="kr">Begin</span><span class="p">{</span><span class="w">
			</span><span class="kr">If</span><span class="p">(</span><span class="o">-not</span><span class="p">(</span><span class="n">Get-AzureADCurrentSessionInfo</span><span class="p">)){</span><span class="n">Connect-AzureAD</span><span class="p">}</span><span class="w">
			</span><span class="nv">$Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">@()</span><span class="w">
		</span><span class="p">}</span><span class="w">
		</span><span class="kr">Process</span><span class="w"> </span><span class="p">{</span><span class="w">
			</span><span class="n">Write-Verbose</span><span class="w"> </span><span class="nt">-Message</span><span class="w"> </span><span class="s2">"Enumerating </span><span class="si">$(</span><span class="nv">$RoleGroup</span><span class="o">.</span><span class="nf">DisplayName</span><span class="si">)</span><span class="s2">"</span><span class="w">
			</span><span class="nv">$Members</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Get-AzureADDirectoryRoleMember</span><span class="w"> </span><span class="nt">-ObjectId</span><span class="w"> </span><span class="nv">$RoleGroup</span><span class="o">.</span><span class="nf">ObjectId</span><span class="w">
			</span><span class="nv">$UserMembers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$Members</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Where-Object</span><span class="p">{</span><span class="bp">$_</span><span class="o">.</span><span class="nf">ObjectType</span><span class="w"> </span><span class="o">-eq</span><span class="w"> </span><span class="s1">'User'</span><span class="p">}</span><span class="w">
			</span><span class="nv">$Output</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nv">$UserMembers</span><span class="w">
			
			</span><span class="nv">$GroupMembers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$Members</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Where-Object</span><span class="p">{</span><span class="bp">$_</span><span class="o">.</span><span class="nf">ObjectType</span><span class="w"> </span><span class="o">-eq</span><span class="w"> </span><span class="s1">'Group'</span><span class="p">}</span><span class="w">
			</span><span class="kr">If</span><span class="p">(</span><span class="nv">$GroupMembers</span><span class="p">){</span><span class="w">
				</span><span class="nv">$UserMembers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$GroupMembers</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">ForEach-Object</span><span class="p">{</span><span class="w"> </span><span class="n">Get-AzureADGroupMemberRecursive</span><span class="w"> </span><span class="nt">-AzureGroup</span><span class="w"> </span><span class="bp">$_</span><span class="p">}</span><span class="w">
				</span><span class="nv">$Output</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nv">$UserMembers</span><span class="w">
			</span><span class="p">}</span><span class="w">
		</span><span class="p">}</span><span class="w">
		</span><span class="kr">end</span><span class="w"> </span><span class="p">{</span><span class="w">
			</span><span class="kr">Return</span><span class="w"> </span><span class="nv">$Output</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Sort-Object</span><span class="w"> </span><span class="nt">-Unique</span><span class="w">
		</span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><p>Below is example output where it retrieves the user <code class="language-plaintext highlighter-rouge">SecurityReader</code> of the role <code class="language-plaintext highlighter-rouge">Security Reader</code> but also the user <code class="language-plaintext highlighter-rouge">NestedGroupUser</code> from the group <code class="language-plaintext highlighter-rouge">NestedGroup</code> which is member of the role. The membership structure is as follows:</p><ul><li>Security Reader<ul><li>SecurityReader@jonyschats.nl<li>NestedGroup<ul><li>NestedGroupUser@jonyschats.nl</ul></ul></ul><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>Get-AzureADDirectoryRole -ObjectId 598a6cfe-5d1a-42a7-81b6-76f4ab077152 | Get-AzureADDirectoryRoleMemberRecursive

ObjectId                             DisplayName     UserPrincipalName             UserType
--------                             -----------     -----------------             --------
1a9a26f4-297a-4dec-95b3-e502ec8e9dfc NestedGroupUser NestedGroupUser@jonyschats.nl Member
fb8a7905-e32c-4431-9e66-2968013f924f SecurityReader  SecurityReader@jonyschats.nl  Member
</pre></table></code></div></div><h1 id="new-cmdlets-for-enumerating-roles">New cmdlets for enumerating roles</h1><h3 id="get-azureaddirectoryroleoverview"><span class="mr-2">Get-AzureADDirectoryRoleOverview</span><a href="#get-azureaddirectoryroleoverview" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>AzureAD has a lot of <a href="https://learn.microsoft.com/en-us/azure/active-directory/roles/permissions-reference">built-in roles</a> but the AzureAD cmdlet <code class="language-plaintext highlighter-rouge">Get-AzureADDirectoryRole</code> only returns the roles which are <a href="https://github.com/Azure/azure-docs-powershell-azuread/issues/245">activated</a>. Using this information we can easily request all activated roles and retrieve its users with the cmdlet I created earlier. But I woud like to get an overview of how many users each role has and who the users are. So I created the cmdlet <code class="language-plaintext highlighter-rouge">Get-AzureADDirectoryRoleOverview</code>:</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
</pre><td class="rouge-code"><pre><span class="kr">Function</span><span class="w"> </span><span class="nf">Get-AzureADDirectoryRoleOverview</span><span class="p">{</span><span class="w">
</span><span class="cm">&lt;#
</span><span class="cs">.SYNOPSIS</span><span class="cm">
Author: Jony Schats - 0xjs
Required Dependencies: Get-AzureADDirectoryRole, Get-AzureADDirectoryRoleMember, Get-AzureADGroupMember, Get-AzureADGroupMemberRecursive
Optional Dependencies: None
</span><span class="cs">.DESCRIPTION</span><span class="cm">
Recursively search through all active Azure AD roles and return a overview of the amount of members a role has and the members itself.
</span><span class="cs">.EXAMPLE</span><span class="cm">
Get-AzureADDirectoryRoleOverview
#&gt;</span><span class="w">
    </span><span class="kr">Begin</span><span class="p">{</span><span class="w">
        </span><span class="kr">If</span><span class="p">(</span><span class="o">-not</span><span class="p">(</span><span class="n">Get-AzureADCurrentSessionInfo</span><span class="p">)){</span><span class="n">Connect-AzureAD</span><span class="p">}</span><span class="w">
		</span><span class="nv">$Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">@()</span><span class="w">
    </span><span class="p">}</span><span class="w">
	
	</span><span class="kr">Process</span><span class="w"> </span><span class="p">{</span><span class="w">
		</span><span class="nv">$AzureADRoles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Get-AzureADDirectoryRole</span><span class="w">

		</span><span class="kr">foreach</span><span class="w"> </span><span class="p">(</span><span class="nv">$AzureADRole</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nv">$AzureADRoles</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
			</span><span class="n">Write-Verbose</span><span class="w"> </span><span class="nt">-Message</span><span class="w"> </span><span class="s2">"Enumerating </span><span class="si">$(</span><span class="nv">$AzureADRole</span><span class="o">.</span><span class="nf">DisplayName</span><span class="si">)</span><span class="s2">"</span><span class="w">
				
			</span><span class="c"># Retrieve members of the AdminRole</span><span class="w">
			</span><span class="nv">$RoleMembers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Get-AzureADDirectoryRole</span><span class="w"> </span><span class="nt">-ObjectId</span><span class="w"> </span><span class="nv">$AzureADRole</span><span class="o">.</span><span class="nf">ObjectId</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Get-AzureADDirectoryRoleMemberRecursive</span><span class="w">
			</span><span class="nv">$RoleMembersCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$RoleMembers</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Sort-Object</span><span class="w"> </span><span class="nt">-Unique</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Measure-Object</span><span class="w">
			
			</span><span class="nv">$item</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">New-Object</span><span class="w"> </span><span class="nx">PSObject</span><span class="w">
			</span><span class="nv">$item</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Add-Member</span><span class="w"> </span><span class="nt">-type</span><span class="w"> </span><span class="nx">NoteProperty</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="s1">'Role'</span><span class="w"> </span><span class="nt">-Value</span><span class="w"> </span><span class="nv">$AzureADRole</span><span class="o">.</span><span class="nf">DisplayName</span><span class="w">
			</span><span class="nv">$item</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Add-Member</span><span class="w"> </span><span class="nt">-type</span><span class="w"> </span><span class="nx">NoteProperty</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="s1">'UserCount'</span><span class="w"> </span><span class="nt">-Value</span><span class="w"> </span><span class="nv">$RoleMembersCount</span><span class="o">.</span><span class="nf">Count</span><span class="w">
			</span><span class="nv">$item</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Add-Member</span><span class="w"> </span><span class="nt">-type</span><span class="w"> </span><span class="nx">NoteProperty</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="s1">'Members'</span><span class="w"> </span><span class="nt">-Value</span><span class="w"> </span><span class="nv">$RoleMembers</span><span class="o">.</span><span class="nf">UserPrincipalName</span><span class="w">
			</span><span class="nv">$Output</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nv">$item</span><span class="w">
			</span><span class="p">}</span><span class="w">
	</span><span class="p">}</span><span class="w">

	</span><span class="kr">end</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="kr">Return</span><span class="w"> </span><span class="nv">$Output</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Sort-Object</span><span class="w"> </span><span class="nt">-Property</span><span class="w"> </span><span class="nx">UserCount</span><span class="w"> </span><span class="nt">-Descending</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><p>The cmdlet retrieves all active roles and their memberships, counts the userobjects after searching recursivly and creates new PowerShell objects with the attributes <code class="language-plaintext highlighter-rouge">Rolename</code>, <code class="language-plaintext highlighter-rouge">Usercount</code> and <code class="language-plaintext highlighter-rouge">Members</code>.</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre>Get-AzureADDirectoryRoleOverview

Role                 UserCount Members
----                 --------- -------
Security Reader              2 {NestedGroupUser@jonyschats.nl, SecurityReader@jonyschats.nl}
Global Reader                1 SecurityReader@jonyschats.nl
Global Administrator         1 0xjs@jonyschats.nl
</pre></table></code></div></div><h3 id="get-azureadprivilegedrolesmembers"><span class="mr-2">Get-AzureADPrivilegedRolesMembers</span><a href="#get-azureadprivilegedrolesmembers" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>We got an overview of all roles used within Azure, the member count and listing the members, but what about privileged roles? There is a warning in Microsoft Security Center which recommends MFA for atleast <a href="https://learn.microsoft.com/en-us/azure/active-directory/conditional-access/howto-conditional-access-policy-admin-mfa">these</a> privileged roles. So I created the PowerShell cmdlet <code class="language-plaintext highlighter-rouge">Get-AzureADPrivilegedRolesMembers</code> which searches recursivly through all these roles and return all user object:</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre><td class="rouge-code"><pre><span class="kr">Function</span><span class="w"> </span><span class="nf">Get-AzureADPrivilegedRolesMembers</span><span class="p">{</span><span class="w">
</span><span class="cm">&lt;#
</span><span class="cs">.SYNOPSIS</span><span class="cm">
Author: Jony Schats - 0xjs
Required Dependencies: Get-AzureADDirectoryRole, Get-AzureADDirectoryRoleMember, Get-AzureADGroupMember, Get-AzureADGroupMemberRecursive
Optional Dependencies: None
</span><span class="cs">.DESCRIPTION</span><span class="cm">
Recursively search through privileged roles and only return unique user objects.
</span><span class="cs">.EXAMPLE</span><span class="cm">
Get-AzureADPrivilegedRolesMembers
#&gt;</span><span class="w">
    </span><span class="kr">Begin</span><span class="p">{</span><span class="w">
        </span><span class="kr">If</span><span class="p">(</span><span class="o">-not</span><span class="p">(</span><span class="n">Get-AzureADCurrentSessionInfo</span><span class="p">)){</span><span class="n">Connect-AzureAD</span><span class="p">}</span><span class="w">
		</span><span class="nv">$AdminRoles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Global administrator"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Application administrator"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Authentication Administrator"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Billing administrator"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Cloud application administrator"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Conditional Access administrator"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Exchange administrator"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Helpdesk administrator"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Password administrator"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Privileged authentication administrator"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Privileged Role Administrator"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Security administrator"</span><span class="p">,</span><span class="w"> </span><span class="s2">"SharePoint administrator"</span><span class="p">,</span><span class="w"> </span><span class="s2">"User administrator"</span><span class="w">
		</span><span class="nv">$Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">@()</span><span class="w">
    </span><span class="p">}</span><span class="w">
	
	</span><span class="kr">Process</span><span class="w"> </span><span class="p">{</span><span class="w">
		</span><span class="kr">foreach</span><span class="w"> </span><span class="p">(</span><span class="nv">$AdminRole</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nv">$AdminRoles</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">			
			</span><span class="nv">$AdminRoleData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Get-AzureADDirectoryRole</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Where-Object</span><span class="w"> </span><span class="nt">-Property</span><span class="w"> </span><span class="nx">Displayname</span><span class="w"> </span><span class="o">-eq</span><span class="w"> </span><span class="nv">$AdminRole</span><span class="w">
			</span><span class="n">Write-Verbose</span><span class="w"> </span><span class="nt">-Message</span><span class="w"> </span><span class="s2">"Enumerating </span><span class="si">$(</span><span class="nv">$AdminRoleData</span><span class="o">.</span><span class="nf">DisplayName</span><span class="si">)</span><span class="s2">"</span><span class="w">
			
			</span><span class="c"># If the role is populated</span><span class="w">
			</span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="nv">$AdminRoleData</span><span class="w"> </span><span class="o">-ne</span><span class="w"> </span><span class="bp">$null</span><span class="p">){</span><span class="w">
				
				</span><span class="c"># Retrieve members of the AdminRole</span><span class="w">
				</span><span class="nv">$AdminRoleMembers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Get-AzureADDirectoryRole</span><span class="w"> </span><span class="nt">-ObjectId</span><span class="w"> </span><span class="nv">$AdminRoleData</span><span class="o">.</span><span class="nf">ObjectId</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Get-AzureADDirectoryRoleMemberRecursive</span><span class="w">
				</span><span class="nv">$Output</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nv">$AdminRoleMembers</span><span class="w">
			</span><span class="p">}</span><span class="w">
		</span><span class="p">}</span><span class="w">
	</span><span class="p">}</span><span class="w">

	</span><span class="kr">end</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="kr">Return</span><span class="w"> </span><span class="nv">$Output</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Sort-Object</span><span class="w"> </span><span class="nt">-Unique</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><p>I only have one <code class="language-plaintext highlighter-rouge">Global Administrator</code> in my tenant so it returns just one object. But it will go through all 14 roles and recursivly search for all users.</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>Get-AzureADPrivilegedRolesMembers

ObjectId                             DisplayName UserPrincipalName  UserType
--------                             ----------- -----------------  --------
766787e8-82c1-4062-bfa9-5d4a4ca300f3 0xjs        0xjs@jonyschats.nl Member
</pre></table></code></div></div><h3 id="get-azureadprivilegedrolesoverview"><span class="mr-2">Get-AzureADPrivilegedRolesOverview</span><a href="#get-azureadprivilegedrolesoverview" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>We already created a overview of all active roles and its members, but I also wanted to have this overview for the privileged roles which we discussed earlier. So I created <code class="language-plaintext highlighter-rouge">Get-AzureADPrivilegedRolesOverview</code>:</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
</pre><td class="rouge-code"><pre><span class="kr">Function</span><span class="w"> </span><span class="nf">Get-AzureADPrivilegedRolesOverview</span><span class="p">{</span><span class="w">
</span><span class="cm">&lt;#
</span><span class="cs">.SYNOPSIS</span><span class="cm">
Author: Jony Schats - 0xjs
Required Dependencies: Get-AzureADDirectoryRole, Get-AzureADDirectoryRoleMember, Get-AzureADGroupMember, Get-AzureADGroupMemberRecursive
Optional Dependencies: None
</span><span class="cs">.DESCRIPTION</span><span class="cm">
Recursively search through privileged Azure AD roles and return a overview of the amount of members a role has and the members itself.
</span><span class="cs">.EXAMPLE</span><span class="cm">
Get-AzureADPrivilegedRolesOverview
#&gt;</span><span class="w">
    </span><span class="kr">Begin</span><span class="p">{</span><span class="w">
        </span><span class="kr">If</span><span class="p">(</span><span class="o">-not</span><span class="p">(</span><span class="n">Get-AzureADCurrentSessionInfo</span><span class="p">)){</span><span class="n">Connect-AzureAD</span><span class="p">}</span><span class="w">
		</span><span class="nv">$AdminRoles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Global administrator"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Application administrator"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Authentication Administrator"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Billing administrator"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Cloud application administrator"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Conditional Access administrator"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Exchange administrator"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Helpdesk administrator"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Password administrator"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Privileged authentication administrator"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Privileged Role Administrator"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Security administrator"</span><span class="p">,</span><span class="w"> </span><span class="s2">"SharePoint administrator"</span><span class="p">,</span><span class="w"> </span><span class="s2">"User administrator"</span><span class="w">
		</span><span class="nv">$Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">@()</span><span class="w">
    </span><span class="p">}</span><span class="w">
	
	</span><span class="kr">Process</span><span class="w"> </span><span class="p">{</span><span class="w">		
		</span><span class="kr">foreach</span><span class="w"> </span><span class="p">(</span><span class="nv">$AdminRole</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nv">$AdminRoles</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
			</span><span class="nv">$AdminRoleData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Get-AzureADDirectoryRole</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Where-Object</span><span class="w"> </span><span class="nt">-Property</span><span class="w"> </span><span class="nx">Displayname</span><span class="w"> </span><span class="o">-eq</span><span class="w"> </span><span class="nv">$AdminRole</span><span class="w">
			</span><span class="n">Write-Verbose</span><span class="w"> </span><span class="nt">-Message</span><span class="w"> </span><span class="s2">"Enumerating </span><span class="si">$(</span><span class="nv">$AdminRoleData</span><span class="o">.</span><span class="nf">DisplayName</span><span class="si">)</span><span class="s2">"</span><span class="w">

			</span><span class="c"># If the role is populated</span><span class="w">
			</span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="nv">$AdminRoleData</span><span class="w"> </span><span class="o">-ne</span><span class="w"> </span><span class="bp">$null</span><span class="p">){</span><span class="w">
				
				</span><span class="c"># Retrieve members of the AdminRole</span><span class="w">
				</span><span class="nv">$AdminRoleMembers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Get-AzureADDirectoryRole</span><span class="w"> </span><span class="nt">-ObjectId</span><span class="w"> </span><span class="nv">$AdminRoleData</span><span class="o">.</span><span class="nf">ObjectId</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Get-AzureADDirectoryRoleMemberRecursive</span><span class="w">
				</span><span class="nv">$AdminRoleMembersCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$AdminRoleMembers</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Sort-Object</span><span class="w"> </span><span class="nt">-Unique</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Measure-Object</span><span class="w">
				
				</span><span class="nv">$item</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">New-Object</span><span class="w"> </span><span class="nx">PSObject</span><span class="w">
				</span><span class="nv">$item</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Add-Member</span><span class="w"> </span><span class="nt">-type</span><span class="w"> </span><span class="nx">NoteProperty</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="s1">'Role'</span><span class="w"> </span><span class="nt">-Value</span><span class="w"> </span><span class="nv">$AdminRoleData</span><span class="o">.</span><span class="nf">DisplayName</span><span class="w">
				</span><span class="nv">$item</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Add-Member</span><span class="w"> </span><span class="nt">-type</span><span class="w"> </span><span class="nx">NoteProperty</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="s1">'UserCount'</span><span class="w"> </span><span class="nt">-Value</span><span class="w"> </span><span class="nv">$AdminRoleMembersCount</span><span class="o">.</span><span class="nf">Count</span><span class="w">
				</span><span class="nv">$item</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Add-Member</span><span class="w"> </span><span class="nt">-type</span><span class="w"> </span><span class="nx">NoteProperty</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="s1">'Members'</span><span class="w"> </span><span class="nt">-Value</span><span class="w"> </span><span class="nv">$AdminRoleMembers</span><span class="o">.</span><span class="nf">UserPrincipalName</span><span class="w">
				</span><span class="nv">$Output</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nv">$item</span><span class="w">
			</span><span class="p">}</span><span class="w">
			</span><span class="kr">else</span><span class="w"> </span><span class="p">{</span><span class="w">
				</span><span class="nv">$item</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">New-Object</span><span class="w"> </span><span class="nx">PSObject</span><span class="w">
				</span><span class="nv">$item</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Add-Member</span><span class="w"> </span><span class="nt">-type</span><span class="w"> </span><span class="nx">NoteProperty</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="s1">'Role'</span><span class="w"> </span><span class="nt">-Value</span><span class="w"> </span><span class="nv">$AdminRole</span><span class="w">
				</span><span class="nv">$item</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Add-Member</span><span class="w"> </span><span class="nt">-type</span><span class="w"> </span><span class="nx">NoteProperty</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="s1">'UserCount'</span><span class="w"> </span><span class="nt">-Value</span><span class="w"> </span><span class="s2">"0"</span><span class="w">
				</span><span class="nv">$Output</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nv">$item</span><span class="w">
			</span><span class="p">}</span><span class="w">
		</span><span class="p">}</span><span class="w">
	</span><span class="p">}</span><span class="w">

	</span><span class="kr">end</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="kr">Return</span><span class="w"> </span><span class="nv">$Output</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Sort-Object</span><span class="w"> </span><span class="nt">-Property</span><span class="w"> </span><span class="nx">UserCount</span><span class="w"> </span><span class="nt">-Descending</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><p>The PowerShell cmdlet also adds a object for the role even if its empty, but you can easily filter this by piping it to a where-object statement such as <code class="language-plaintext highlighter-rouge">| Where-Object -Property UserCount -NE 0</code>.</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre><td class="rouge-code"><pre>Get-AzureADPrivilegedRolesOverview

Role                                    UserCount Members
----                                    --------- -------
Global Administrator                            1 0xjs@jonyschats.nl
Privileged Role Administrator                   0
Privileged authentication administrator         0
Password administrator                          0
User administrator                              0
SharePoint administrator                        0
Security administrator                          0
Helpdesk administrator                          0
Billing administrator                           0
Authentication Administrator                    0
Application administrator                       0
Exchange administrator                          0
Conditional Access administrator                0
Cloud application administrator                 0


Get-AzureADPrivilegedRolesOverview | Where-Object -Property UserCount -NE 0

Role                 UserCount Members
----                 --------- -------
Global Administrator         1 0xjs@jonyschats.nl
</pre></table></code></div></div><h1 id="github">GitHub</h1><p>All the cmdlets can be found in my GitHub project <a href="https://github.com/0xJs/AzurePowerCommands">AzurePowerCommand</a>.</p><p>The next blog in the series will be about GroupOwners.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/ethical-hacking/'>Ethical Hacking</a>, <a href='/categories/azure/'>Azure</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/ethical-hacking/" class="post-tag no-text-decoration" >ethical hacking</a> <a href="/tags/azure/" class="post-tag no-text-decoration" >azure</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Searching recursivly through Azure AD Groups and Roles - Jony Schats / 0xjs&amp;url=https://0xjs.github.io/posts/Searching-recursivl-through-Azure-AD-Groups-and-Roles/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Searching recursivly through Azure AD Groups and Roles - Jony Schats / 0xjs&amp;u=https://0xjs.github.io/posts/Searching-recursivl-through-Azure-AD-Groups-and-Roles/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https://0xjs.github.io/posts/Searching-recursivl-through-Azure-AD-Groups-and-Roles/&amp;text=Searching recursivly through Azure AD Groups and Roles - Jony Schats / 0xjs" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/PNPT-review/">PNPT review</a><li><a href="/posts/CRTO-review/">CRTO review</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/ethical-hacking/">ethical hacking</a> <a class="post-tag" href="/tags/azure/">azure</a> <a class="post-tag" href="/tags/red-teaming/">red teaming</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/Do-you-check-for-group-owners-of-privileged-roles/"><div class="card-body"> <em class="timeago small" data-ts="1668537600" > 2022-11-15 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Do you check for group owners of privileged roles?</h3><div class="text-muted small"><p> Introduction This is the second blog in the series. If you havent read the first one you can find it here. In the previous blogpost we focussed on retrieving userobjects from groups and roles and c...</p></div></div></a></div><div class="card"> <a href="/posts/Service-principals-did-you-know-they-can-have-owners-too/"><div class="card-body"> <em class="timeago small" data-ts="1669662720" > 2022-11-28 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Service principals, did you know they can have owners too?</h3><div class="text-muted small"><p> Introduction This is the third blog in the series. If you haven’t read the first or second blog I recommend reading them. In the previous blogpost we focussed on retrieving group owners and that th...</p></div></div></a></div><div class="card"> <a href="/posts/Identifying-highly-privileged-identities-and-checking-MFA-status/"><div class="card-body"> <em class="timeago small" data-ts="1671392100" > 2022-12-18 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Identifying highly privileged identities and checking MFA status</h3><div class="text-muted small"><p> Introduction This is the fourth blog in the series. If you haven’t read the previous blog you can find it here. In the previous blogs we discussed the different types of identities and how we can f...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/PNPT-review/" class="btn btn-outline-primary" prompt="Older"><p>PNPT review</p></a> <a href="/posts/Do-you-check-for-group-owners-of-privileged-roles/" class="btn btn-outline-primary" prompt="Newer"><p>Do you check for group owners of privileged roles?</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://twitter.com/_0xJs_">Jony Schats</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/ethical-hacking/">ethical hacking</a> <a class="post-tag" href="/tags/azure/">azure</a> <a class="post-tag" href="/tags/red-teaming/">red teaming</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
