<!DOCTYPE html><html lang="en" data-mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Identifying highly privileged identities and checking MFA status" /><meta name="author" content="Jony Schats" /><meta property="og:locale" content="en" /><meta name="description" content="Introduction This is the fourth blog in the series. If you haven’t read the previous blog you can find it here. In the previous blogs we discussed the different types of identities and how we can find high privileged identities. In those blogs PowerShell cmdlets were created which helped querying these different types of identities. In this blog everything will be tied together into one cmdlet and we will have a look at MFA." /><meta property="og:description" content="Introduction This is the fourth blog in the series. If you haven’t read the previous blog you can find it here. In the previous blogs we discussed the different types of identities and how we can find high privileged identities. In those blogs PowerShell cmdlets were created which helped querying these different types of identities. In this blog everything will be tied together into one cmdlet and we will have a look at MFA." /><link rel="canonical" href="https://0xjs.github.io/posts/Identifying-highly-privileged-identities-and-checking-MFA-status/" /><meta property="og:url" content="https://0xjs.github.io/posts/Identifying-highly-privileged-identities-and-checking-MFA-status/" /><meta property="og:site_name" content="Jony Schats / 0xjs" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-12-18T20:35:00+01:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Identifying highly privileged identities and checking MFA status" /><meta name="twitter:site" content="@_0xJs_" /><meta name="twitter:creator" content="@Jony Schats" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Jony Schats"},"dateModified":"2022-12-18T20:35:00+01:00","datePublished":"2022-12-18T20:35:00+01:00","description":"Introduction This is the fourth blog in the series. If you haven’t read the previous blog you can find it here. In the previous blogs we discussed the different types of identities and how we can find high privileged identities. In those blogs PowerShell cmdlets were created which helped querying these different types of identities. In this blog everything will be tied together into one cmdlet and we will have a look at MFA.","headline":"Identifying highly privileged identities and checking MFA status","mainEntityOfPage":{"@type":"WebPage","@id":"https://0xjs.github.io/posts/Identifying-highly-privileged-identities-and-checking-MFA-status/"},"url":"https://0xjs.github.io/posts/Identifying-highly-privileged-identities-and-checking-MFA-status/"}</script><title>Identifying highly privileged identities and checking MFA status | Jony Schats / 0xjs</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Jony Schats / 0xjs"><meta name="application-name" content="Jony Schats / 0xjs"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src=" https://hackdefense.nl/imager/images/team/14056/DSC_5203_mod_24616cf13bdaf96affec076df364e814.jpg " alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Jony Schats / 0xjs</a></div><div class="site-subtitle font-italic">Ethical Hacker & Security enthusiast</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/0xjs" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/_0xJs_" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['me AT jonyschats.nl',''].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Identifying highly privileged identities and checking MFA status</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Identifying highly privileged identities and checking MFA status</h1><div class="post-meta text-muted"><div> By <em> <a href="https://twitter.com/_0xJs_">Jony Schats</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" data-ts="1671392100" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2022-12-18 </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2100 words"> <em>11 min</em> read</span></div></div></div><div class="post-content"><h1 id="introduction">Introduction</h1><p>This is the fourth blog in the series. If you haven’t read the previous blog you can find it <a href="https://jonyschats.nl/posts/Service-principals-did-you-know-they-can-have-owners-too/">here</a>. In the previous blogs we discussed the different types of identities and how we can find high privileged identities. In those blogs PowerShell cmdlets were created which helped querying these different types of identities. In this blog everything will be tied together into one cmdlet and we will have a look at MFA.</p><p>A quick recap of what we have learned in the previous blogposts:</p><ul><li>Roles can be assigned these three identities and these identities:<ul><li>Users<li>Groups<ul><li>Can’t have nested groups when assigned to roles.<li>Can have owners (Users or service principals)</ul><li>ServicePrincipals<ul><li>Can have Owners (Users)<li>Can have permissions</ul></ul></ul><h1 id="identifying-highly-privileged-identities">Identifying highly privileged identities</h1><p>Microsoft define <a href="https://learn.microsoft.com/en-us/azure/active-directory/conditional-access/howto-conditional-access-policy-admin-mfa">these</a> 14 roles highly privileged. So to get a overview of all the highly privileged identities in the Azure Tenant we should query the following using the created cmdlets:</p><p>1 Users, we can query this with: <code class="language-plaintext highlighter-rouge">Get-AzureADPrivilegedRolesMembers</code></p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>Get-AzureADPrivilegedRolesMembers

ObjectId                             DisplayName UserPrincipalName       UserType
--------                             ----------- -----------------       --------
766787e8-82c1-4062-bfa9-5d4a4ca300f3 0xjs        0xjs@jonyschats.nl      Member
eb815e66-31a5-45ca-bed8-2b0f5e24f62f GroupUser   GroupUser@jonyschats.nl Member
</pre></table></code></div></div><p>2 Privileged group owners, we can query this with <code class="language-plaintext highlighter-rouge">Get-AzureADPrivilegedRolesMembers -ReturnGroup | Get-AzureADGroupOwner</code>.</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>Get-AzureADPrivilegedRolesMembers -ReturnGroup | Get-AzureADGroupOwner

ObjectId                             DisplayName    UserPrincipalName            UserType
--------                             -----------    -----------------            --------
2cc999ae-fe8e-4ce9-a18a-309d68f5bce2 GroupOwnerUser GroupOwnerUser@jonyschats.nl Member
</pre></table></code></div></div><p>3 Privileged service principals, we can query this with <code class="language-plaintext highlighter-rouge">Get-AzureADPrivilegedRolesMembers -ReturnServicePrincipals </code></p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>Get-AzureADPrivilegedRolesMembers -ReturnServicePrincipals

ObjectId                             AppId                                DisplayName
--------                             -----                                -----------
5530a9cf-a45a-4662-9179-eaa8d9089605 1a93dd32-5ade-4656-9ada-6a285676eb92 Test_enterpriseapp
</pre></table></code></div></div><p>4 Privileged service principal owners, we can query this with <code class="language-plaintext highlighter-rouge">Get-AzureADPrivilegedRolesMembers -ReturnServicePrincipals | Get-AzureADServicePrincipalOwner</code></p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>Get-AzureADPrivilegedRolesMembers -ReturnServicePrincipals | Get-AzureADServicePrincipalOwner

ObjectId                             DisplayName           UserPrincipalName                   UserType
--------                             -----------           -----------------                   --------
59b28e90-d96b-410b-acc6-fa9ee823bfbd ServicePrincipalOwner ServicePrincipalOwner@jonyschats.nl Member
</pre></table></code></div></div><p>5 Service principals with permissions configured/consented. Well… that is something for a whole new blog.</p><p>Since nobody likes to run multiple commands I created another PowerShell cmdlet, which is <code class="language-plaintext highlighter-rouge">Get-AzureADPrivilegedIdentities</code>. This cmdlet queries this information and gathers the user and service principal objects and returns them:</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
</pre><td class="rouge-code"><pre><span class="kr">Function</span><span class="w"> </span><span class="nf">Get-AzureADPrivilegedIdentities</span><span class="p">{</span><span class="w">
</span><span class="cm">&lt;#
</span><span class="cs">.SYNOPSIS</span><span class="cm">
Author: Jony Schats - 0xjs
Required Dependencies: Get-AzureADPrivilegedRolesMembers, Get-AzureADDirectoryRole, Get-AzureADDirectoryRoleMember, Get-AzureADGroupMember, Get-AzureADGroupMemberRecursive
Optional Dependencies: None

</span><span class="cs">.DESCRIPTION</span><span class="cm">
Recursively search through privileged roles and return users and service principal identities and their owners

</span><span class="cs">.EXAMPLE</span><span class="cm">
Get-AzureADPrivilegedIdentities

#&gt;</span><span class="w">
	</span><span class="p">[</span><span class="n">cmdletbinding</span><span class="p">()]</span><span class="w">
	</span><span class="kr">param</span><span class="p">(</span><span class="w">

	</span><span class="p">)</span><span class="w">
	
    </span><span class="kr">Begin</span><span class="p">{</span><span class="w">
		</span><span class="c"># Check if Azure AD is loaded</span><span class="w">
		</span><span class="kr">If</span><span class="p">(</span><span class="o">-not</span><span class="p">(</span><span class="n">Get-Command</span><span class="w"> </span><span class="o">*</span><span class="nx">Get-AzureADCurrentSessionInfo</span><span class="o">*</span><span class="p">)){</span><span class="w">
			</span><span class="n">Write-Host</span><span class="w"> </span><span class="nt">-ForegroundColor</span><span class="w"> </span><span class="nx">Red</span><span class="w"> </span><span class="s2">"AzureAD Module not imported, stopping"</span><span class="w">
			</span><span class="kr">break</span><span class="w">
		</span><span class="p">}</span><span class="w">
        
		</span><span class="c"># Check connection with AzureAD</span><span class="w">
		</span><span class="kr">try</span><span class="w"> </span><span class="p">{</span><span class="w">
			</span><span class="nv">$var</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Get-AzureADTenantDetail</span><span class="w">
		</span><span class="p">}</span><span class="w">
		</span><span class="kr">catch</span><span class="w"> </span><span class="p">{</span><span class="w">
			</span><span class="n">Write-Host</span><span class="w"> </span><span class="nt">-ForegroundColor</span><span class="w"> </span><span class="nx">Red</span><span class="w"> </span><span class="s2">"You're not connected with AzureAD, Connect with Connect-AzureAD"</span><span class="w">
			</span><span class="kr">break</span><span class="w">
		</span><span class="p">}</span><span class="w">
		
		</span><span class="nv">$AllUsers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">@()</span><span class="w">
		</span><span class="nv">$AllServicePrincipals</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">@()</span><span class="w">
		</span><span class="nv">$Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">@()</span><span class="w">
    </span><span class="p">}</span><span class="w">
	
	</span><span class="kr">Process</span><span class="w"> </span><span class="p">{</span><span class="w">
		</span><span class="c"># Retrieving privileged users member of role</span><span class="w">
		</span><span class="nv">$Users</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Get-AzureADPrivilegedRolesMembers</span><span class="w">
		</span><span class="nv">$AllUsers</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nv">$users</span><span class="w">
		</span><span class="nv">$UsersCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nv">$Users</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Measure-Object</span><span class="p">)</span><span class="o">.</span><span class="nf">count</span><span class="w">
		</span><span class="n">Write-Host</span><span class="w"> </span><span class="s2">"[+] Discovered </span><span class="nv">$UsersCount</span><span class="s2"> users"</span><span class="w">
		
		</span><span class="c"># Retrieving privileged group owners</span><span class="w">
		</span><span class="nv">$GroupOwners</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Get-AzureADPrivilegedRolesMembers</span><span class="w"> </span><span class="nt">-ReturnGroup</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Get-AzureADGroupOwner</span><span class="w">
		</span><span class="nv">$AllUsers</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nv">$GroupOwners</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Where-Object</span><span class="w"> </span><span class="nt">-Property</span><span class="w"> </span><span class="nx">ObjectType</span><span class="w"> </span><span class="o">-Match</span><span class="w"> </span><span class="nx">User</span><span class="w">
		</span><span class="nv">$AllServicePrincipals</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nv">$GroupOwners</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Where-Object</span><span class="w"> </span><span class="nt">-Property</span><span class="w"> </span><span class="nx">ObjectType</span><span class="w"> </span><span class="o">-Match</span><span class="w"> </span><span class="nx">ServicePrincipal</span><span class="w">
		</span><span class="nv">$CountGroupOwners</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nv">$Users</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Measure-Object</span><span class="p">)</span><span class="o">.</span><span class="nf">count</span><span class="w">
		</span><span class="n">Write-Host</span><span class="w"> </span><span class="s2">"[+] Discovered </span><span class="nv">$CountGroupOwners</span><span class="s2"> group owners"</span><span class="w">
		
		</span><span class="c"># Retrieving privileged service principals</span><span class="w">
		</span><span class="nv">$ServicePrincipals</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Get-AzureADPrivilegedRolesMembers</span><span class="w"> </span><span class="nt">-ReturnServicePrincipals</span><span class="w">
		</span><span class="nv">$AllServicePrincipals</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nv">$ServicePrincipals</span><span class="w">
		</span><span class="nv">$CountServicePrincipals</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nv">$ServicePrincipals</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Measure-Object</span><span class="p">)</span><span class="o">.</span><span class="nf">count</span><span class="w">
		</span><span class="n">Write-Host</span><span class="w"> </span><span class="s2">"[+] Discovered </span><span class="nv">$CountServicePrincipals</span><span class="s2"> service principals"</span><span class="w">
		
		</span><span class="c"># Retrieving privileged service principal owners</span><span class="w">
		</span><span class="nv">$ServicePrincipalOwners</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Get-AzureADPrivilegedRolesMembers</span><span class="w"> </span><span class="nt">-ReturnServicePrincipals</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Get-AzureADServicePrincipalOwner</span><span class="w">
		</span><span class="nv">$AllUsers</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nv">$ServicePrincipalOwners</span><span class="w">
		</span><span class="nv">$CountServicePrincipalOwners</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nv">$ServicePrincipalOwners</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Measure-Object</span><span class="p">)</span><span class="o">.</span><span class="nf">count</span><span class="w">
		</span><span class="n">Write-Host</span><span class="w"> </span><span class="s2">"[+] Discovered </span><span class="nv">$CountServicePrincipalOwners</span><span class="s2"> service principal owners"</span><span class="w">
		
		</span><span class="nv">$CountAllUsers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nv">$AllUsers</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Measure-Object</span><span class="p">)</span><span class="o">.</span><span class="nf">count</span><span class="w">
		</span><span class="n">Write-Host</span><span class="w"> </span><span class="s2">"[+] Found </span><span class="nv">$CountAllUsers</span><span class="s2"> highly privileged users"</span><span class="w">
		</span><span class="nv">$CountAllServicePrincipals</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nv">$AllServicePrincipals</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Measure-Object</span><span class="p">)</span><span class="o">.</span><span class="nf">count</span><span class="w">
		</span><span class="n">Write-Host</span><span class="w"> </span><span class="s2">"[+] Found </span><span class="nv">$CountAllServicePrincipals</span><span class="s2"> highly privileged service principals"</span><span class="w">
		
		</span><span class="nv">$AllUsers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$AllUsers</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Sort-Object</span><span class="w"> </span><span class="nt">-Unique</span><span class="w">
		</span><span class="nv">$AllServicePrincipals</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$AllServicePrincipals</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Sort-Object</span><span class="w"> </span><span class="nt">-Unique</span><span class="w">
		
		</span><span class="nv">$Output</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nv">$AllUsers</span><span class="w">
		</span><span class="nv">$Output</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nv">$AllServicePrincipals</span><span class="w">
	</span><span class="p">}</span><span class="w">

	</span><span class="kr">end</span><span class="w"> </span><span class="p">{</span><span class="w">
		</span><span class="kr">return</span><span class="w"> </span><span class="nv">$Output</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">ft</span><span class="w"> </span><span class="nt">-Force</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><p>The output:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre>Get-AzureADPrivilegedIdentities

[+] Discovered 2 users
[+] Discovered 2 group owners
[+] Discovered 1 service principals
[+] Discovered 1 service principal owners
[+] Found 4 highly privileged users
[+] Found 2 highly privileged service principals

ObjectId                             DisplayName              UserPrincipalName                   UserType
--------                             -----------              -----------------                   --------
2cc999ae-fe8e-4ce9-a18a-309d68f5bce2 GroupOwnerUser           GroupOwnerUser@jonyschats.nl        Member
59b28e90-d96b-410b-acc6-fa9ee823bfbd ServicePrincipalOwner    ServicePrincipalOwner@jonyschats.nl Member
766787e8-82c1-4062-bfa9-5d4a4ca300f3 0xjs                     0xjs@jonyschats.nl                  Member
eb815e66-31a5-45ca-bed8-2b0f5e24f62f GroupUser                GroupUser@jonyschats.nl             Member
5530a9cf-a45a-4662-9179-eaa8d9089605 Test_enterpriseapp
5fef25d5-9886-42df-9d98-de37f6ffd299 Test_enterpriseapp_owner
</pre></table></code></div></div><h1 id="mfa-configuration">MFA Configuration</h1><p>One good thing to check is if all users have MFA enabled. To check this the command <code class="language-plaintext highlighter-rouge">Get-MsolUser</code> from the <a href="https://learn.microsoft.com/en-us/powershell/module/msonline/?view=azureadps-1.0">MSOnline</a> module can be used. The interesting attributes related to MFA are: <code class="language-plaintext highlighter-rouge">StrongAuthenticationMethods</code> and <code class="language-plaintext highlighter-rouge">StrongAuthenticationRequirements</code>. When we query the user <code class="language-plaintext highlighter-rouge">0xjs</code> from my tenant we can see the following:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre>Get-MsolUser -ObjectId 766787e8-82c1-4062-bfa9-5d4a4ca300f3 | Select-Object Displayname, StrongAuthenticationMethods, StrongAuthenticationRequirements |fl


DisplayName                      : 0xjs
StrongAuthenticationMethods      : {Microsoft.Online.Administration.StrongAuthenticationMethod, Microsoft.Online.Administration.StrongAuthenticationMethod,
                                   Microsoft.Online.Administration.StrongAuthenticationMethod, Microsoft.Online.Administration.StrongAuthenticationMethod}
StrongAuthenticationRequirements : {Microsoft.Online.Administration.StrongAuthenticationRequirement}
</pre></table></code></div></div><p>The attribute <code class="language-plaintext highlighter-rouge">StrongAuthenticationMethods</code> holds another PowerShell object and when we open it up we retrieve every authentication method configured and which one is the default. In the example below the PhoneAppNotification is the default MFA method but SMS, Phonecall and a OTP method is also enabled for the user <code class="language-plaintext highlighter-rouge">0xjs</code>. This is because I configured every authentication method possible on my account.</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre>(Get-MsolUser -ObjectId 766787e8-82c1-4062-bfa9-5d4a4ca300f3 | Select-Object Displayname, StrongAuthenticationMethods, StrongAuthenticationRequirements).StrongAuthenticationMethods

ExtensionData                                    IsDefault MethodType
-------------                                    --------- ----------
System.Runtime.Serialization.ExtensionDataObject     False OneWaySMS
System.Runtime.Serialization.ExtensionDataObject     False TwoWayVoiceMobile
System.Runtime.Serialization.ExtensionDataObject     False PhoneAppOTP
System.Runtime.Serialization.ExtensionDataObject      True PhoneAppNotification
</pre></table></code></div></div><p>When we query the user <code class="language-plaintext highlighter-rouge">SecurityReader</code> where I didn’t configure every method we only see two methods enabled:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>(Get-MsolUser -ObjectId fb8a7905-e32c-4431-9e66-2968013f924f | Select-Object Displayname, StrongAuthenticationMethods, StrongAuthenticationRequirements).StrongAuthenticationMethods

ExtensionData                                    IsDefault MethodType
-------------                                    --------- ----------
System.Runtime.Serialization.ExtensionDataObject      True PhoneAppNotification
System.Runtime.Serialization.ExtensionDataObject     False PhoneAppOTP
</pre></table></code></div></div><p>The attribute <code class="language-plaintext highlighter-rouge">StrongAuthenticationRequirements</code> holds the Per-User MFA configuration. This configuration should not be used if Conditional Access policies exist since it will overwrite them and will always require MFA even if the policies say it doesn’t need to.</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>(Get-MsolUser -ObjectId 766787e8-82c1-4062-bfa9-5d4a4ca300f3 | Select-Object Displayname, StrongAuthenticationMethods, StrongAuthenticationRequirements).StrongAuthenticationRequirements

ExtensionData                                    RelyingParty RememberDevicesNotIssuedBefore State
-------------                                    ------------ ------------------------------ -----
System.Runtime.Serialization.ExtensionDataObject *            11/11/2022 10:36:14 AM         Enforced
</pre></table></code></div></div><p>To combine this information I created the cmdlet <code class="language-plaintext highlighter-rouge">Get-AzureADUserMFAConfiguration</code>. This cmdlet takes a user from <code class="language-plaintext highlighter-rouge">Get-MsolUser</code> or <code class="language-plaintext highlighter-rouge">Get-AzureAdUser</code>. By default it will display if MFA is configured and what the default MFA method is and what the status is of Per-User MFA.</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
</pre><td class="rouge-code"><pre><span class="kr">Function</span><span class="w"> </span><span class="nf">Get-AzureADUserMFAConfiguration</span><span class="p">{</span><span class="w">
</span><span class="cm">&lt;#
</span><span class="cs">.SYNOPSIS</span><span class="cm">
Author: Jony Schats - 0xjs
Required Dependencies: Get-MsolUser
Optional Dependencies: None

</span><span class="cs">.DESCRIPTION</span><span class="cm">
Get MFA configuration data for the user. Requires a user as input.

</span><span class="cs">.PARAMETER</span><span class="cm"> Detailed
If specified will create detailed MFA configuration objects

</span><span class="cs">.EXAMPLE</span><span class="cm">
Get-AzureADUser | Get-AzureADUserMFAConfiguration
Get MFA configuration data of all users

</span><span class="cs">.EXAMPLE</span><span class="cm">
Get-MsolUser | Get-AzureADUserMFAConfiguration
Get MFA configuration data of all users

</span><span class="cs">.EXAMPLE</span><span class="cm">
Get-MsolUser | Get-AzureADUserMFAConfiguration -Detailed
Get detailed MFA configuration data of all users

</span><span class="cs">.EXAMPLE</span><span class="cm">
Get-AzureADPrivilegedRolesMembers | Get-AzureADUserMFAConfiguration
Get MFA configuration data for all users of privileges roles

</span><span class="cs">.EXAMPLE</span><span class="cm">
Get-AzureADPrivilegedRolesMembers | Get-AzureADUserMFAConfiguration -Detailed
Get detailed MFA configuration data for all users of privileges roles
#&gt;</span><span class="w">
	</span><span class="p">[</span><span class="n">OutputType</span><span class="p">(</span><span class="s1">'System.Management.Automation.PSCustomObject'</span><span class="p">)]</span><span class="w">
	</span><span class="p">[</span><span class="n">cmdletbinding</span><span class="p">()]</span><span class="w">
	</span><span class="kr">param</span><span class="p">(</span><span class="w">
	</span><span class="p">[</span><span class="n">parameter</span><span class="p">(</span><span class="n">Mandatory</span><span class="o">=</span><span class="nv">$True</span><span class="p">,</span><span class="n">ValueFromPipeline</span><span class="o">=</span><span class="bp">$true</span><span class="p">)]</span><span class="w">
	</span><span class="nv">$User</span><span class="p">,</span><span class="w">
	</span><span class="p">[</span><span class="n">Parameter</span><span class="p">(</span><span class="n">Mandatory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">$false</span><span class="p">)]</span><span class="w">
	</span><span class="p">[</span><span class="n">Switch</span><span class="p">]</span><span class="w">
	</span><span class="nv">$Detailed</span><span class="w">
	</span><span class="p">)</span><span class="w">
		</span><span class="kr">Begin</span><span class="p">{</span><span class="w">
			</span><span class="c"># Check if MSOnline is loaded</span><span class="w">
			</span><span class="kr">If</span><span class="p">(</span><span class="o">-not</span><span class="p">(</span><span class="n">Get-Command</span><span class="w"> </span><span class="o">*</span><span class="nx">Get-MsolCompanyInformation</span><span class="o">*</span><span class="p">)){</span><span class="w">
				</span><span class="n">Write-Host</span><span class="w"> </span><span class="nt">-ForegroundColor</span><span class="w"> </span><span class="nx">Red</span><span class="w"> </span><span class="s2">"MSOnline Module not imported, stopping"</span><span class="w">
				</span><span class="kr">break</span><span class="w">
			</span><span class="p">}</span><span class="w">
			
			</span><span class="c"># Check connection with MSOnline</span><span class="w">
			</span><span class="kr">try</span><span class="w"> </span><span class="p">{</span><span class="w">
				</span><span class="nv">$var</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Get-MsolDomain</span><span class="w"> </span><span class="nt">-ErrorAction</span><span class="w"> </span><span class="nx">Stop</span><span class="w"> </span><span class="err">&gt;</span><span class="w"> </span><span class="bp">$null</span><span class="w">
			</span><span class="p">}</span><span class="w">
			</span><span class="kr">catch</span><span class="w"> </span><span class="p">{</span><span class="w">
				</span><span class="n">Write-Host</span><span class="w"> </span><span class="nt">-ForegroundColor</span><span class="w"> </span><span class="nx">Red</span><span class="w"> </span><span class="s2">"You're not connected with MSOnline, Connect with Connect-MsolService"</span><span class="w">
				</span><span class="kr">break</span><span class="w">
			</span><span class="p">}</span><span class="w">
		
			</span><span class="nv">$Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">@()</span><span class="w">
		</span><span class="p">}</span><span class="w">
		
		</span><span class="kr">Process</span><span class="w"> </span><span class="p">{</span><span class="w">
			</span><span class="nv">$User</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Get-MsolUser</span><span class="w"> </span><span class="nt">-ObjectId</span><span class="w"> </span><span class="bp">$_</span><span class="o">.</span><span class="nf">ObjectId</span><span class="w"> 
			
			</span><span class="nv">$MFADefault</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">""</span><span class="w">
			</span><span class="nv">$MFAConfigured</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">""</span><span class="w">
			</span><span class="nv">$MFADefaultMethod</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">""</span><span class="w">
				
			</span><span class="nv">$MFADefault</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$User</span><span class="o">.</span><span class="nf">StrongAuthenticationMethods</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Where-Object</span><span class="w"> </span><span class="nt">-Property</span><span class="w"> </span><span class="nx">IsDefault</span><span class="w"> </span><span class="o">-EQ</span><span class="w"> </span><span class="nv">$True</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Select-Object</span><span class="w"> </span><span class="nt">-ExpandProperty</span><span class="w"> </span><span class="nx">MethodType</span><span class="w">
			
			</span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="nv">$User</span><span class="o">.</span><span class="nf">StrongAuthenticationMethods</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
				</span><span class="nv">$MFAConfigured</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">$true</span><span class="w">
			</span><span class="p">}</span><span class="w">
			</span><span class="kr">else</span><span class="w"> </span><span class="p">{</span><span class="w">
				</span><span class="nv">$MFAConfigured</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">$false</span><span class="w">
			</span><span class="p">}</span><span class="w">

			</span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="nv">$MFADefault</span><span class="w"> </span><span class="o">-eq</span><span class="w"> </span><span class="s2">"PhoneAppNotification"</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
				</span><span class="nv">$MFADefaultMethod</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Microsoft Authenticator"</span><span class="w">
			</span><span class="p">}</span><span class="w">
			</span><span class="kr">elseif</span><span class="w"> </span><span class="p">(</span><span class="nv">$MFADefault</span><span class="w"> </span><span class="o">-eq</span><span class="w"> </span><span class="s2">"PhoneAppOTP"</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
				</span><span class="nv">$MFADefaultMethod</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"HW token / Authenticator"</span><span class="w">
			</span><span class="p">}</span><span class="w">
			</span><span class="kr">elseif</span><span class="w"> </span><span class="p">(</span><span class="nv">$MFADefault</span><span class="w"> </span><span class="o">-eq</span><span class="w"> </span><span class="s2">"OneWaySMS"</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
				</span><span class="nv">$MFADefaultMethod</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"SMS"</span><span class="w">
			</span><span class="p">}</span><span class="w">
			</span><span class="kr">elseif</span><span class="w"> </span><span class="p">(</span><span class="nv">$MFADefault</span><span class="w"> </span><span class="o">-eq</span><span class="w"> </span><span class="s2">"TwoWayVoiceMobile"</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
				</span><span class="nv">$MFADefaultMethod</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Voice"</span><span class="w">
			</span><span class="p">}</span><span class="w">
			
			</span><span class="nv">$item</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">New-Object</span><span class="w"> </span><span class="nx">PSObject</span><span class="w">
			</span><span class="nv">$item</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Add-Member</span><span class="w"> </span><span class="nt">-type</span><span class="w"> </span><span class="nx">NoteProperty</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="s1">'UserPrincipalName'</span><span class="w"> </span><span class="nt">-Value</span><span class="w"> </span><span class="nv">$User</span><span class="o">.</span><span class="nf">UserPrincipalName</span><span class="w">
			</span><span class="nv">$item</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Add-Member</span><span class="w"> </span><span class="nt">-type</span><span class="w"> </span><span class="nx">NoteProperty</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="s1">'MFA Configured'</span><span class="w"> </span><span class="nt">-Value</span><span class="w"> </span><span class="nv">$MFAConfigured</span><span class="w">
			</span><span class="nv">$item</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Add-Member</span><span class="w"> </span><span class="nt">-type</span><span class="w"> </span><span class="nx">NoteProperty</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="s1">'MFA Default'</span><span class="w"> </span><span class="nt">-Value</span><span class="w"> </span><span class="nv">$MFADefaultMethod</span><span class="w">
			
			</span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="nv">$User</span><span class="o">.</span><span class="nf">StrongAuthenticationRequirements</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
					</span><span class="nv">$item</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Add-Member</span><span class="w"> </span><span class="nt">-type</span><span class="w"> </span><span class="nx">NoteProperty</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="s1">'Per-User MFA'</span><span class="w"> </span><span class="nt">-Value</span><span class="w"> </span><span class="nv">$User</span><span class="o">.</span><span class="nf">StrongAuthenticationRequirements</span><span class="o">.</span><span class="nf">State</span><span class="w">
				</span><span class="p">}</span><span class="w"> </span><span class="kr">else</span><span class="w"> </span><span class="p">{</span><span class="w">
					</span><span class="nv">$item</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Add-Member</span><span class="w"> </span><span class="nt">-type</span><span class="w"> </span><span class="nx">NoteProperty</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="s1">'Per-User MFA'</span><span class="w"> </span><span class="nt">-Value</span><span class="w"> </span><span class="s2">"-"</span><span class="w">
			</span><span class="p">}</span><span class="w">
			
			</span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="nv">$Detailed</span><span class="p">){</span><span class="w">
				</span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="nv">$User</span><span class="o">.</span><span class="nf">StrongAuthenticationMethods</span><span class="o">.</span><span class="nf">MethodType</span><span class="w"> </span><span class="o">-contains</span><span class="w"> </span><span class="s2">"OneWaySMS"</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
				</span><span class="nv">$item</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Add-Member</span><span class="w"> </span><span class="nt">-type</span><span class="w"> </span><span class="nx">NoteProperty</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="s1">'OneWaySMS'</span><span class="w"> </span><span class="nt">-Value</span><span class="w"> </span><span class="bp">$true</span><span class="w">
				</span><span class="p">}</span><span class="w"> </span><span class="kr">else</span><span class="w"> </span><span class="p">{</span><span class="w">
					</span><span class="nv">$item</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Add-Member</span><span class="w"> </span><span class="nt">-type</span><span class="w"> </span><span class="nx">NoteProperty</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="s1">'OneWaySMS'</span><span class="w"> </span><span class="nt">-Value</span><span class="w"> </span><span class="s2">"-"</span><span class="w">
				</span><span class="p">}</span><span class="w">
				
				</span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="nv">$User</span><span class="o">.</span><span class="nf">StrongAuthenticationMethods</span><span class="o">.</span><span class="nf">MethodType</span><span class="w"> </span><span class="o">-contains</span><span class="w"> </span><span class="s2">"TwoWayVoiceMobile"</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
					</span><span class="nv">$item</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Add-Member</span><span class="w"> </span><span class="nt">-type</span><span class="w"> </span><span class="nx">NoteProperty</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="s1">'TwoWayVoiceMobile'</span><span class="w"> </span><span class="nt">-Value</span><span class="w"> </span><span class="bp">$true</span><span class="w">
				</span><span class="p">}</span><span class="w"> </span><span class="kr">else</span><span class="w"> </span><span class="p">{</span><span class="w">
					</span><span class="nv">$item</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Add-Member</span><span class="w"> </span><span class="nt">-type</span><span class="w"> </span><span class="nx">NoteProperty</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="s1">'TwoWayVoiceMobile'</span><span class="w"> </span><span class="nt">-Value</span><span class="w"> </span><span class="s2">"-"</span><span class="w">
				</span><span class="p">}</span><span class="w">
				
				</span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="nv">$User</span><span class="o">.</span><span class="nf">StrongAuthenticationMethods</span><span class="o">.</span><span class="nf">MethodType</span><span class="w"> </span><span class="o">-contains</span><span class="w"> </span><span class="s2">"PhoneAppOTP"</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
					</span><span class="nv">$item</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Add-Member</span><span class="w"> </span><span class="nt">-type</span><span class="w"> </span><span class="nx">NoteProperty</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="s1">'PhoneAppOTP'</span><span class="w"> </span><span class="nt">-Value</span><span class="w"> </span><span class="bp">$true</span><span class="w">
				</span><span class="p">}</span><span class="w"> </span><span class="kr">else</span><span class="w"> </span><span class="p">{</span><span class="w">
					</span><span class="nv">$item</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Add-Member</span><span class="w"> </span><span class="nt">-type</span><span class="w"> </span><span class="nx">NoteProperty</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="s1">'PhoneAppOTP'</span><span class="w"> </span><span class="nt">-Value</span><span class="w"> </span><span class="s2">"-"</span><span class="w">
				</span><span class="p">}</span><span class="w">
				
				</span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="nv">$User</span><span class="o">.</span><span class="nf">StrongAuthenticationMethods</span><span class="o">.</span><span class="nf">MethodType</span><span class="w"> </span><span class="o">-contains</span><span class="w"> </span><span class="s2">"PhoneAppNotification"</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
					</span><span class="nv">$item</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Add-Member</span><span class="w"> </span><span class="nt">-type</span><span class="w"> </span><span class="nx">NoteProperty</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="s1">'PhoneAppNotification'</span><span class="w"> </span><span class="nt">-Value</span><span class="w"> </span><span class="bp">$true</span><span class="w">
				</span><span class="p">}</span><span class="w"> </span><span class="kr">else</span><span class="w"> </span><span class="p">{</span><span class="w">
					</span><span class="nv">$item</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Add-Member</span><span class="w"> </span><span class="nt">-type</span><span class="w"> </span><span class="nx">NoteProperty</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="s1">'PhoneAppNotification'</span><span class="w"> </span><span class="nt">-Value</span><span class="w"> </span><span class="s2">"-"</span><span class="w">
				</span><span class="p">}</span><span class="w">
				
				</span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="nv">$User</span><span class="o">.</span><span class="nf">StrongAuthenticationUserDetails</span><span class="o">.</span><span class="nf">Email</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
					</span><span class="nv">$item</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Add-Member</span><span class="w"> </span><span class="nt">-type</span><span class="w"> </span><span class="nx">NoteProperty</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="s1">'Registered Email'</span><span class="w"> </span><span class="nt">-Value</span><span class="w"> </span><span class="nv">$User</span><span class="o">.</span><span class="nf">StrongAuthenticationUserDetails</span><span class="o">.</span><span class="nf">Email</span><span class="w">
				</span><span class="p">}</span><span class="w"> </span><span class="kr">else</span><span class="w"> </span><span class="p">{</span><span class="w">
					</span><span class="nv">$item</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Add-Member</span><span class="w"> </span><span class="nt">-type</span><span class="w"> </span><span class="nx">NoteProperty</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="s1">'Registered Email'</span><span class="w"> </span><span class="nt">-Value</span><span class="w"> </span><span class="s2">"-"</span><span class="w">
				</span><span class="p">}</span><span class="w">
				
				</span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="nv">$User</span><span class="o">.</span><span class="nf">StrongAuthenticationUserDetails</span><span class="o">.</span><span class="nf">PhoneNumber</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
					</span><span class="nv">$item</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Add-Member</span><span class="w"> </span><span class="nt">-type</span><span class="w"> </span><span class="nx">NoteProperty</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="s1">'Registered Phone'</span><span class="w"> </span><span class="nt">-Value</span><span class="w"> </span><span class="nv">$User</span><span class="o">.</span><span class="nf">StrongAuthenticationUserDetails</span><span class="o">.</span><span class="nf">PhoneNumber</span><span class="w">
				</span><span class="p">}</span><span class="w"> </span><span class="kr">else</span><span class="w"> </span><span class="p">{</span><span class="w">
					</span><span class="nv">$item</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Add-Member</span><span class="w"> </span><span class="nt">-type</span><span class="w"> </span><span class="nx">NoteProperty</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="s1">'Registered Phone'</span><span class="w"> </span><span class="nt">-Value</span><span class="w"> </span><span class="s2">"-"</span><span class="w">
				</span><span class="p">}</span><span class="w">
			</span><span class="p">}</span><span class="w">
			
			</span><span class="nv">$Output</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nv">$item</span><span class="w">
		</span><span class="p">}</span><span class="w">

		</span><span class="kr">end</span><span class="w"> </span><span class="p">{</span><span class="w">
			</span><span class="nv">$Output</span><span class="w">
		</span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><p>Example output:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>Get-MsolUser -ObjectId 766787e8-82c1-4062-bfa9-5d4a4ca300f3 | Get-AzureADUserMFAConfiguration

UserPrincipalName  MFA Configured MFA Default             Per-User MFA
-----------------  -------------- -----------             ------------
0xjs@jonyschats.nl           True Microsoft Authenticator Enforced
</pre></table></code></div></div><p>It is also possible to pipe all users to this cmdlet (might take a while in big environments):</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre>Get-MsolUser | Get-AzureADUserMFAConfiguration

UserPrincipalName                   MFA Configured MFA Default              Per-User MFA
-----------------                   -------------- -----------              ------------
NestedGroupUser@jonyschats.nl                 True HW token / Authenticator -
GroupOwnerUser@jonyschats.nl                 False                          -
ServicePrincipalOwner@jonyschats.nl          False                          -
0xjs@jonyschats.nl                            True Microsoft Authenticator  Enforced
GroupUser@jonyschats.nl                       True Microsoft Authenticator  -
SecurityReader@jonyschats.nl                  True Microsoft Authenticator  -
</pre></table></code></div></div><p>If detailed information is prefered there is a flag for that, use the <code class="language-plaintext highlighter-rouge">-Detailed</code> flag and the output will be:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
</pre><td class="rouge-code"><pre>Get-MsolUser | Get-AzureADUserMFAConfiguration -Detailed


UserPrincipalName    : NestedGroupUser@jonyschats.nl
MFA Configured       : True
MFA Default          : HW token / Authenticator
Per-User MFA         : -
OneWaySMS            : -
TwoWayVoiceMobile    : -
PhoneAppOTP          : True
PhoneAppNotification : -
Registered Email     : -
Registered Phone     : -

...snip...

UserPrincipalName    : 0xjs@jonyschats.nl
MFA Configured       : True
MFA Default          : Microsoft Authenticator
Per-User MFA         : Enforced
OneWaySMS            : True
TwoWayVoiceMobile    : True
PhoneAppOTP          : True
PhoneAppNotification : True
Registered Email     : fakeemail@jonyschats.nl
Registered Phone     : +31 06123456789

...snip...

UserPrincipalName    : SecurityReader@jonyschats.nl
MFA Configured       : True
MFA Default          : Microsoft Authenticator
Per-User MFA         : -
OneWaySMS            : -
TwoWayVoiceMobile    : -
PhoneAppOTP          : True
PhoneAppNotification : True
Registered Email     : -
Registered Phone     : -
</pre></table></code></div></div><p>Remember when we were talking about privileged users and objects etc. We can also pipe these users to the cmdlet and quickly retrieve the MFA configuration of all privileged users within the tenant. Serviceprincipals can’t have MFA configured!</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>Get-AzureADPrivilegedRolesMembers | Get-AzureADUserMFAConfiguration

UserPrincipalName       MFA Configured MFA Default             Per-User MFA
-----------------       -------------- -----------             ------------
0xjs@jonyschats.nl                True Microsoft Authenticator Enforced
GroupUser@jonyschats.nl           True Microsoft Authenticator -
</pre></table></code></div></div><p>We can quickly use the created cmdlets to get a overview of all privileged objects within the tenant and their MFA status and configuration and use this data to protect the Azure tenant.</p><h1 id="github">GitHub</h1><p>All the cmdlets can be found in my GitHub project <a href="https://github.com/0xJs/AzurePowerCommands">AzurePowerCommands</a>.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/ethical-hacking/'>Ethical Hacking</a>, <a href='/categories/azure/'>Azure</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/ethical-hacking/" class="post-tag no-text-decoration" >ethical hacking</a> <a href="/tags/azure/" class="post-tag no-text-decoration" >azure</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Identifying highly privileged identities and checking MFA status - Jony Schats / 0xjs&amp;url=https://0xjs.github.io/posts/Identifying-highly-privileged-identities-and-checking-MFA-status/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Identifying highly privileged identities and checking MFA status - Jony Schats / 0xjs&amp;u=https://0xjs.github.io/posts/Identifying-highly-privileged-identities-and-checking-MFA-status/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https://0xjs.github.io/posts/Identifying-highly-privileged-identities-and-checking-MFA-status/&amp;text=Identifying highly privileged identities and checking MFA status - Jony Schats / 0xjs" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/PNPT-review/">PNPT review</a><li><a href="/posts/CRTO-review/">CRTO review</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/ethical-hacking/">ethical hacking</a> <a class="post-tag" href="/tags/azure/">azure</a> <a class="post-tag" href="/tags/red-teaming/">red teaming</a></div></div></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/Searching-recursivl-through-Azure-AD-Groups-and-Roles/"><div class="card-body"> <em class="timeago small" data-ts="1668253500" > 2022-11-12 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Searching recursivly through Azure AD Groups and Roles</h3><div class="text-muted small"><p> Introduction During some courses I have been working with the AzureAD PowerShell Module to retrieve information from Users, Groups, Roles etc. While working with these cmdlets it was annoying that ...</p></div></div></a></div><div class="card"> <a href="/posts/Do-you-check-for-group-owners-of-privileged-roles/"><div class="card-body"> <em class="timeago small" data-ts="1668537600" > 2022-11-15 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Do you check for group owners of privileged roles?</h3><div class="text-muted small"><p> Introduction This is the second blog in the series. If you havent read the first one you can find it here. In the previous blogpost we focussed on retrieving userobjects from groups and roles and c...</p></div></div></a></div><div class="card"> <a href="/posts/Service-principals-did-you-know-they-can-have-owners-too/"><div class="card-body"> <em class="timeago small" data-ts="1669662720" > 2022-11-28 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Service principals, did you know they can have owners too?</h3><div class="text-muted small"><p> Introduction This is the third blog in the series. If you haven’t read the first or second blog I recommend reading them. In the previous blogpost we focussed on retrieving group owners and that th...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/Service-principals-did-you-know-they-can-have-owners-too/" class="btn btn-outline-primary" prompt="Older"><p>Service principals, did you know they can have owners too?</p></a> <a href="/posts/CESP-review/" class="btn btn-outline-primary" prompt="Newer"><p>CESP review</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://twitter.com/_0xJs_">Jony Schats</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/ethical-hacking/">ethical hacking</a> <a class="post-tag" href="/tags/azure/">azure</a> <a class="post-tag" href="/tags/red-teaming/">red teaming</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
