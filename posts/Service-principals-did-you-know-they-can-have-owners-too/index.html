<!DOCTYPE html><html lang="en" data-mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Service principals, did you know they can have owners too?" /><meta name="author" content="Jony Schats" /><meta property="og:locale" content="en" /><meta name="description" content="Introduction This is the third blog in the series. If you haven’t read the first or second blog I recommend reading them. In the previous blogpost we focussed on retrieving group owners and that they should be considered as high privileged users if the group he owns is member of a high privileged role. In this blogpost we will have a look at Service Principals and they can have owners too!" /><meta property="og:description" content="Introduction This is the third blog in the series. If you haven’t read the first or second blog I recommend reading them. In the previous blogpost we focussed on retrieving group owners and that they should be considered as high privileged users if the group he owns is member of a high privileged role. In this blogpost we will have a look at Service Principals and they can have owners too!" /><link rel="canonical" href="https://0xjs.github.io/posts/Service-principals-did-you-know-they-can-have-owners-too/" /><meta property="og:url" content="https://0xjs.github.io/posts/Service-principals-did-you-know-they-can-have-owners-too/" /><meta property="og:site_name" content="Jony Schats / 0xjs" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-11-28T20:12:00+01:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Service principals, did you know they can have owners too?" /><meta name="twitter:site" content="@_0xJs_" /><meta name="twitter:creator" content="@Jony Schats" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Jony Schats"},"dateModified":"2022-11-28T20:12:00+01:00","datePublished":"2022-11-28T20:12:00+01:00","description":"Introduction This is the third blog in the series. If you haven’t read the first or second blog I recommend reading them. In the previous blogpost we focussed on retrieving group owners and that they should be considered as high privileged users if the group he owns is member of a high privileged role. In this blogpost we will have a look at Service Principals and they can have owners too!","headline":"Service principals, did you know they can have owners too?","mainEntityOfPage":{"@type":"WebPage","@id":"https://0xjs.github.io/posts/Service-principals-did-you-know-they-can-have-owners-too/"},"url":"https://0xjs.github.io/posts/Service-principals-did-you-know-they-can-have-owners-too/"}</script><title>Service principals, did you know they can have owners too? | Jony Schats / 0xjs</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Jony Schats / 0xjs"><meta name="application-name" content="Jony Schats / 0xjs"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src=" https://hackdefense.nl/imager/images/team/14056/DSC_5203_mod_24616cf13bdaf96affec076df364e814.jpg " alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Jony Schats / 0xjs</a></div><div class="site-subtitle font-italic">Ethical Hacker & Security enthusiast</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/0xjs" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/_0xJs_" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['me AT jonyschats.nl',''].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Service principals, did you know they can have owners too?</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Service principals, did you know they can have owners too?</h1><div class="post-meta text-muted"><div> By <em> <a href="https://twitter.com/_0xJs_">Jony Schats</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" data-ts="1669662720" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2022-11-28 </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1195 words"> <em>6 min</em> read</span></div></div></div><div class="post-content"><h1 id="introduction">Introduction</h1><p>This is the third blog in the series. If you haven’t read the <a href="https://jonyschats.nl/posts/What-is-the-MFA-status-of-your-users/">first</a> or <a href="https://jonyschats.nl/posts/Do-you-check-for-group-owners-of-privileged-roles/">second</a> blog I recommend reading them. In the previous blogpost we focussed on retrieving group owners and that they should be considered as high privileged users if the group he owns is member of a high privileged role. In this blogpost we will have a look at Service Principals and they can have owners too!</p><h1 id="service-princpals">Service princpals</h1><p>In the first blog we discussed that there are three identities that can access resources; Users, Groups and Service Principals. You might be wondering what is a service principal, <a href="https://learn.microsoft.com/en-us/azure/active-directory/develop/app-objects-and-service-principals">Microsoft</a> defines;</p><p>A service principal is created in each tenant where the application is used and references the globally unique app object. The service principal object defines what the app can actually do in the specific tenant, who can access the app, and what resources the app can access.</p><p>As an example I created an app in my Azure Active Directory in “App registrations” with the name <code class="language-plaintext highlighter-rouge">Test_enterpriseapp</code>.</p><p><img data-src="/assets/img/app_registration.png" alt="Exam timeline" data-proofer-ignore></p><p>When creating the app, a service principal is automatically registered and can be found in the “Enterprise application” section of Azure Active Directory.</p><p><img data-src="/assets/img/service_principal.png" alt="Exam timeline" data-proofer-ignore></p><p>If my app needs to access any resources within my Azure tenant it will use this service principal. For example; I could give this service principal permissions to read certain keys or certificates out of a Azure keyvault. When I give a app from somebody else permissions to access my tenant, a service principal is also created. This could be an app from somebody else or for Example <a href="https://developer.microsoft.com/en-us/graph/graph-explorer">Microsoft Graph Explorer</a>. After logging in I receive a prompt to give permissions:</p><p><img data-src="/assets/img/graph.png" alt="Exam timeline" data-proofer-ignore></p><p>After giving consent the service principal is added to our tenant with permissions and roles</p><p><img data-src="/assets/img/service_principal2.png" alt="Exam timeline" data-proofer-ignore></p><p>In a later blog we will dive into these permissions since its a complicated concept.</p><h1 id="service-princpals-owners">Service princpals owners</h1><p>Just like the groups, a service principal can also have an owner. So if a high priviliged role has a service principal in its member and that service principal has a owner, this user should also be considered highly privileged. In my tenant I added the service principal <code class="language-plaintext highlighter-rouge">Test_enterpriseapp</code> to the <code class="language-plaintext highlighter-rouge">Authentication Administrator</code> role and added a user <code class="language-plaintext highlighter-rouge">ServicePrincipalOwner</code> as owner of the service principal.</p><p>To accomodate retrieving the service principals in the cmdlets of <a href="https://github.com/0xJs/AzurePowerCommands">AzurePowerCommands</a> I added the <code class="language-plaintext highlighter-rouge">-ReturnServicePrincipals</code> parameter which will return service principals in the same way I did for the <code class="language-plaintext highlighter-rouge">-ReturenGroups</code>.</p><p>When you run the cmdlet <code class="language-plaintext highlighter-rouge">Get-AzureADPrivilegedRolesMembers</code> with the parameter <code class="language-plaintext highlighter-rouge">-ReturnServicePrincipals</code> it will search recursivly through the 14 roles for service principals and return them:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>Get-AzureADPrivilegedRolesMembers -ReturnServicePrincipals

ObjectId                             AppId                                DisplayName
--------                             -----                                -----------
5530a9cf-a45a-4662-9179-eaa8d9089605 1a93dd32-5ade-4656-9ada-6a285676eb92 Test_enterpriseapp
</pre></table></code></div></div><p>When we run <code class="language-plaintext highlighter-rouge">Get-AzureADPrivilegedRolesMembers -ReturnServicePrincipals</code> and pipe it to <code class="language-plaintext highlighter-rouge">Get-AzureADServicePrincipalOwner</code>. The following will happen:</p><ul><li>loop through the 14 privileged roles<li>search for all service principals and also in groups and return service principals<li>these service principals will be piped to retrieve the owners of all the service principals</ul><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>Get-AzureADPrivilegedRolesMembers -ReturnServicePrincipals | Get-AzureADServicePrincipalOwner

ObjectId                             DisplayName           UserPrincipalName                   UserType
--------                             -----------           -----------------                   --------
59b28e90-d96b-410b-acc6-fa9ee823bfbd ServicePrincipalOwner ServicePrincipalOwner@jonyschats.nl Member
</pre></table></code></div></div><h2 id="updating-the-overview-cmdlet"><span class="mr-2">Updating the overview cmdlet</span><a href="#updating-the-overview-cmdlet" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>To get a good overview again I changed the existing <code class="language-plaintext highlighter-rouge">Get-AzureADPrivilegedRolesOverview</code> cmdlet and added the SPsCount, SPs and SPsOwners attributes.</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
</pre><td class="rouge-code"><pre><span class="kr">Function</span><span class="w"> </span><span class="nf">Get-AzureADPrivilegedRolesOverview</span><span class="p">{</span><span class="w">
</span><span class="cm">&lt;#
</span><span class="cs">.SYNOPSIS</span><span class="cm">
Author: Jony Schats - 0xjs
Required Dependencies: Get-AzureADDirectoryRole, Get-AzureADDirectoryRoleMember, Get-AzureADGroupMember, Get-AzureADGroupMemberRecursive
Optional Dependencies: None

</span><span class="cs">.DESCRIPTION</span><span class="cm">
Recursively search through privileged Azure AD roles and return a overview of the amount of members a role has and the members itself.

</span><span class="cs">.EXAMPLE</span><span class="cm">
Get-AzureADPrivilegedRolesOverview

#&gt;</span><span class="w">
    </span><span class="kr">Begin</span><span class="p">{</span><span class="w">
		</span><span class="c"># Check if Azure AD is loaded</span><span class="w">
		</span><span class="kr">If</span><span class="p">(</span><span class="o">-not</span><span class="p">(</span><span class="n">Get-Command</span><span class="w"> </span><span class="o">*</span><span class="nx">Get-AzureADCurrentSessionInfo</span><span class="o">*</span><span class="p">)){</span><span class="w">
			</span><span class="n">Write-Host</span><span class="w"> </span><span class="nt">-ForegroundColor</span><span class="w"> </span><span class="nx">Red</span><span class="w"> </span><span class="s2">"AzureAD Module not imported, stopping"</span><span class="w">
			</span><span class="kr">break</span><span class="w">
		</span><span class="p">}</span><span class="w">
        
		</span><span class="c"># Check connection with AzureAD</span><span class="w">
		</span><span class="kr">try</span><span class="w"> </span><span class="p">{</span><span class="w">
			</span><span class="nv">$var</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Get-AzureADTenantDetail</span><span class="w">
		</span><span class="p">}</span><span class="w">
		</span><span class="kr">catch</span><span class="w"> </span><span class="p">{</span><span class="w">
			</span><span class="n">Write-Host</span><span class="w"> </span><span class="nt">-ForegroundColor</span><span class="w"> </span><span class="nx">Red</span><span class="w"> </span><span class="s2">"You're not connected with AzureAD, Connect with Connect-AzureAD"</span><span class="w">
			</span><span class="kr">break</span><span class="w">
		</span><span class="p">}</span><span class="w">
		
		</span><span class="nv">$AdminRoles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Global administrator"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Application administrator"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Authentication Administrator"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Billing administrator"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Cloud application administrator"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Conditional Access administrator"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Exchange administrator"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Helpdesk administrator"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Password administrator"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Privileged authentication administrator"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Privileged Role Administrator"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Security administrator"</span><span class="p">,</span><span class="w"> </span><span class="s2">"SharePoint administrator"</span><span class="p">,</span><span class="w"> </span><span class="s2">"User administrator"</span><span class="w">
		</span><span class="nv">$Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">@()</span><span class="w">
    </span><span class="p">}</span><span class="w">
	
	</span><span class="kr">Process</span><span class="w"> </span><span class="p">{</span><span class="w">		
		</span><span class="kr">foreach</span><span class="w"> </span><span class="p">(</span><span class="nv">$AdminRole</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nv">$AdminRoles</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
			</span><span class="nv">$AdminRoleData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Get-AzureADDirectoryRole</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Where-Object</span><span class="w"> </span><span class="nt">-Property</span><span class="w"> </span><span class="nx">Displayname</span><span class="w"> </span><span class="o">-eq</span><span class="w"> </span><span class="nv">$AdminRole</span><span class="w">
			</span><span class="n">Write-Verbose</span><span class="w"> </span><span class="nt">-Message</span><span class="w"> </span><span class="s2">"Enumerating </span><span class="si">$(</span><span class="nv">$AdminRoleData</span><span class="o">.</span><span class="nf">DisplayName</span><span class="si">)</span><span class="s2">"</span><span class="w">

			</span><span class="c"># If the role is populated</span><span class="w">
			</span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="nv">$AdminRoleData</span><span class="w"> </span><span class="o">-ne</span><span class="w"> </span><span class="bp">$null</span><span class="p">){</span><span class="w">
				
				</span><span class="c"># Retrieve members of the AdminRole</span><span class="w">
				</span><span class="nv">$AdminRoleMembersUsers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Get-AzureADDirectoryRole</span><span class="w"> </span><span class="nt">-ObjectId</span><span class="w"> </span><span class="nv">$AdminRoleData</span><span class="o">.</span><span class="nf">ObjectId</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Get-AzureADDirectoryRoleMemberRecursive</span><span class="w">
				</span><span class="nv">$AdminRoleMembersUsersCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$AdminRoleMembersUsers</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Sort-Object</span><span class="w"> </span><span class="nt">-Unique</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Measure-Object</span><span class="w">
				
				</span><span class="nv">$AdminRoleMembersGroups</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Get-AzureADDirectoryRole</span><span class="w"> </span><span class="nt">-ObjectId</span><span class="w"> </span><span class="nv">$AdminRoleData</span><span class="o">.</span><span class="nf">ObjectId</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Get-AzureADDirectoryRoleMemberRecursive</span><span class="w"> </span><span class="nt">-ReturnGroups</span><span class="w">
				</span><span class="nv">$AdminRoleMembersGroupsCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$AdminRoleMembersGroups</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Sort-Object</span><span class="w"> </span><span class="nt">-Unique</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Measure-Object</span><span class="w">
				</span><span class="nv">$GroupOwners</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Get-AzureADDirectoryRole</span><span class="w"> </span><span class="nt">-ObjectId</span><span class="w"> </span><span class="nv">$AdminRoleData</span><span class="o">.</span><span class="nf">ObjectId</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Get-AzureADDirectoryRoleMemberRecursive</span><span class="w"> </span><span class="nt">-ReturnGroups</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Get-AzureADGroupOwner</span><span class="w">
				
				</span><span class="nv">$AdminRoleMembersSPs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Get-AzureADDirectoryRole</span><span class="w"> </span><span class="nt">-ObjectId</span><span class="w"> </span><span class="nv">$AdminRoleData</span><span class="o">.</span><span class="nf">ObjectId</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Get-AzureADDirectoryRoleMemberRecursive</span><span class="w"> </span><span class="nt">-ReturnServicePrincipals</span><span class="w">
				</span><span class="nv">$AdminRoleMembersSPsCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$AdminRoleMembersSPs</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Sort-Object</span><span class="w"> </span><span class="nt">-Unique</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Measure-Object</span><span class="w">
				</span><span class="nv">$ServicePrincipalOwners</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Get-AzureADDirectoryRole</span><span class="w"> </span><span class="nt">-ObjectId</span><span class="w"> </span><span class="nv">$AdminRoleData</span><span class="o">.</span><span class="nf">ObjectId</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Get-AzureADDirectoryRoleMemberRecursive</span><span class="w"> </span><span class="nt">-ReturnServicePrincipals</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Get-AzureADServicePrincipalOwner</span><span class="w">
				
				</span><span class="nv">$item</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">New-Object</span><span class="w"> </span><span class="nx">PSObject</span><span class="w">
				</span><span class="nv">$item</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Add-Member</span><span class="w"> </span><span class="nt">-type</span><span class="w"> </span><span class="nx">NoteProperty</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="s1">'Role'</span><span class="w"> </span><span class="nt">-Value</span><span class="w"> </span><span class="nv">$AdminRoleData</span><span class="o">.</span><span class="nf">DisplayName</span><span class="w">
				
				</span><span class="nv">$item</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Add-Member</span><span class="w"> </span><span class="nt">-type</span><span class="w"> </span><span class="nx">NoteProperty</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="s1">'UserCount'</span><span class="w"> </span><span class="nt">-Value</span><span class="w"> </span><span class="nv">$AdminRoleMembersUsersCount</span><span class="o">.</span><span class="nf">Count</span><span class="w">
				</span><span class="nv">$item</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Add-Member</span><span class="w"> </span><span class="nt">-type</span><span class="w"> </span><span class="nx">NoteProperty</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="s1">'Users'</span><span class="w"> </span><span class="nt">-Value</span><span class="w"> </span><span class="nv">$AdminRoleMembersUsers</span><span class="o">.</span><span class="nf">UserPrincipalName</span><span class="w">
				
				</span><span class="nv">$item</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Add-Member</span><span class="w"> </span><span class="nt">-type</span><span class="w"> </span><span class="nx">NoteProperty</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="s1">'GroupCount'</span><span class="w"> </span><span class="nt">-Value</span><span class="w"> </span><span class="nv">$AdminRoleMembersGroupsCount</span><span class="o">.</span><span class="nf">Count</span><span class="w">
				</span><span class="nv">$item</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Add-Member</span><span class="w"> </span><span class="nt">-type</span><span class="w"> </span><span class="nx">NoteProperty</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="s1">'Groups'</span><span class="w"> </span><span class="nt">-Value</span><span class="w"> </span><span class="nv">$AdminRoleMembersGroups</span><span class="o">.</span><span class="nf">DisplayName</span><span class="w">
				</span><span class="nv">$item</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Add-Member</span><span class="w"> </span><span class="nt">-type</span><span class="w"> </span><span class="nx">NoteProperty</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="s1">'GroupOwners'</span><span class="w"> </span><span class="nt">-Value</span><span class="w"> </span><span class="nv">$GroupOwners</span><span class="o">.</span><span class="nf">UserPrincipalName</span><span class="w">
				
				</span><span class="nv">$item</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Add-Member</span><span class="w"> </span><span class="nt">-type</span><span class="w"> </span><span class="nx">NoteProperty</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="s1">'SPsCount'</span><span class="w"> </span><span class="nt">-Value</span><span class="w"> </span><span class="nv">$AdminRoleMembersSPsCount</span><span class="o">.</span><span class="nf">Count</span><span class="w">
				</span><span class="nv">$item</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Add-Member</span><span class="w"> </span><span class="nt">-type</span><span class="w"> </span><span class="nx">NoteProperty</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="s1">'SPs'</span><span class="w"> </span><span class="nt">-Value</span><span class="w"> </span><span class="nv">$AdminRoleMembersSPs</span><span class="o">.</span><span class="nf">DisplayName</span><span class="w">
				</span><span class="nv">$item</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Add-Member</span><span class="w"> </span><span class="nt">-type</span><span class="w"> </span><span class="nx">NoteProperty</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="s1">'SPsOwners'</span><span class="w"> </span><span class="nt">-Value</span><span class="w"> </span><span class="nv">$ServicePrincipalOwners</span><span class="o">.</span><span class="nf">UserPrincipalName</span><span class="w">
				
				</span><span class="nv">$Output</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nv">$item</span><span class="w">
			</span><span class="p">}</span><span class="w">
			</span><span class="kr">else</span><span class="w"> </span><span class="p">{</span><span class="w">
				</span><span class="nv">$item</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">New-Object</span><span class="w"> </span><span class="nx">PSObject</span><span class="w">
				</span><span class="nv">$item</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Add-Member</span><span class="w"> </span><span class="nt">-type</span><span class="w"> </span><span class="nx">NoteProperty</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="s1">'Role'</span><span class="w"> </span><span class="nt">-Value</span><span class="w"> </span><span class="nv">$AdminRole</span><span class="w">
				</span><span class="nv">$item</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Add-Member</span><span class="w"> </span><span class="nt">-type</span><span class="w"> </span><span class="nx">NoteProperty</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="s1">'UserCount'</span><span class="w"> </span><span class="nt">-Value</span><span class="w"> </span><span class="s2">"0"</span><span class="w">
				</span><span class="nv">$item</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Add-Member</span><span class="w"> </span><span class="nt">-type</span><span class="w"> </span><span class="nx">NoteProperty</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="s1">'GroupCount'</span><span class="w"> </span><span class="nt">-Value</span><span class="w"> </span><span class="s2">"0"</span><span class="w">
				</span><span class="nv">$item</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Add-Member</span><span class="w"> </span><span class="nt">-type</span><span class="w"> </span><span class="nx">NoteProperty</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="s1">'SPsCount'</span><span class="w"> </span><span class="nt">-Value</span><span class="w"> </span><span class="s2">"0"</span><span class="w">
				</span><span class="nv">$Output</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nv">$item</span><span class="w">
			</span><span class="p">}</span><span class="w">
		</span><span class="p">}</span><span class="w">
	</span><span class="p">}</span><span class="w">

	</span><span class="kr">end</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="kr">Return</span><span class="w"> </span><span class="nv">$Output</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Sort-Object</span><span class="w"> </span><span class="nt">-Property</span><span class="w"> </span><span class="nx">UserCount</span><span class="w"> </span><span class="nt">-Descending</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><p>The output:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre>Get-AzureADPrivilegedRolesOverview | ft

Role                                    UserCount Users                   GroupCount Groups        GroupOwners                         SPsCount SPs                SPsOwners
----                                    --------- -----                   ---------- ------        -----------                         -------- ---                ---------
Authentication Administrator                    1 GroupUser@jonyschats.nl          1 Administrator ServicePrincipalOwner@jonyschats.nl        1 Test_enterpriseapp ServicePrincipalOwner@jonyschats.nl
Global Administrator                            1 0xjs@jonyschats.nl               0                                                          0
Privileged Role Administrator                   0                                  0                                                          0
Privileged authentication administrator         0                                  0                                                          0
Password administrator                          0                                  0                                                          0
User Administrator                              0                                  0                                                          0
SharePoint administrator                        0                                  0                                                          0
Security administrator                          0                                  0                                                          0
Cloud application administrator                 0                                  0                                                          0
Billing administrator                           0                                  0                                                          0
Application administrator                       0                                  0                                                          0
Helpdesk administrator                          0                                  0                                                          0
Exchange administrator                          0                                  0                                                          0
Conditional Access administrator                0                                  0                                                          0
</pre></table></code></div></div><h1 id="quick-recap">Quick recap</h1><p>A quick recap of what we have learned about Azure AD identities:</p><ul><li>Roles can be assigned these three identities and these identities:<ul><li>Users<li>Groups<ul><li>Can’t have nested groups when assigned to roles.<li>Can have owners</ul><li>ServicePrincipals<ul><li>Can have Owners<li>Can have permissions</ul></ul></ul><p>In the next blog we will dive into retrieving all the privileged identities and checking their MFA configuration.</p><h1 id="github">GitHub</h1><p>All the cmdlets can be found in my GitHub project <a href="https://github.com/0xJs/AzurePowerCommands">AzurePowerCommands</a>.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/ethical-hacking/'>Ethical Hacking</a>, <a href='/categories/azure/'>Azure</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/ethical-hacking/" class="post-tag no-text-decoration" >ethical hacking</a> <a href="/tags/azure/" class="post-tag no-text-decoration" >azure</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Service principals, did you know they can have owners too? - Jony Schats / 0xjs&amp;url=https://0xjs.github.io/posts/Service-principals-did-you-know-they-can-have-owners-too/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Service principals, did you know they can have owners too? - Jony Schats / 0xjs&amp;u=https://0xjs.github.io/posts/Service-principals-did-you-know-they-can-have-owners-too/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https://0xjs.github.io/posts/Service-principals-did-you-know-they-can-have-owners-too/&amp;text=Service principals, did you know they can have owners too? - Jony Schats / 0xjs" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/PNPT-review/">PNPT review</a><li><a href="/posts/CRTO-review/">CRTO review</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/ethical-hacking/">ethical hacking</a> <a class="post-tag" href="/tags/azure/">azure</a> <a class="post-tag" href="/tags/red-teaming/">red teaming</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/Searching-recursivl-through-Azure-AD-Groups-and-Roles/"><div class="card-body"> <em class="timeago small" data-ts="1668253500" > 2022-11-12 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Searching recursivly through Azure AD Groups and Roles</h3><div class="text-muted small"><p> Introduction During some courses I have been working with the AzureAD PowerShell Module to retrieve information from Users, Groups, Roles etc. While working with these cmdlets it was annoying that ...</p></div></div></a></div><div class="card"> <a href="/posts/Do-you-check-for-group-owners-of-privileged-roles/"><div class="card-body"> <em class="timeago small" data-ts="1668537600" > 2022-11-15 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Do you check for group owners of privileged roles?</h3><div class="text-muted small"><p> Introduction This is the second blog in the series. If you havent read the first one you can find it here. In the previous blogpost we focussed on retrieving userobjects from groups and roles and c...</p></div></div></a></div><div class="card"> <a href="/posts/Identifying-highly-privileged-identities-and-checking-MFA-status/"><div class="card-body"> <em class="timeago small" data-ts="1671392100" > 2022-12-18 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Identifying highly privileged identities and checking MFA status</h3><div class="text-muted small"><p> Introduction This is the fourth blog in the series. If you haven’t read the previous blog you can find it here. In the previous blogs we discussed the different types of identities and how we can f...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/PentesterAcademy-PACES-review/" class="btn btn-outline-primary" prompt="Older"><p>PentesterAcademy Certified Enterprise Security Specialist (PACES) review</p></a> <a href="/posts/Identifying-highly-privileged-identities-and-checking-MFA-status/" class="btn btn-outline-primary" prompt="Newer"><p>Identifying highly privileged identities and checking MFA status</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://twitter.com/_0xJs_">Jony Schats</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/ethical-hacking/">ethical hacking</a> <a class="post-tag" href="/tags/azure/">azure</a> <a class="post-tag" href="/tags/red-teaming/">red teaming</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
